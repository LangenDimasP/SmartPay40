{% extends 'base_siswa.html' %}
{% block title %}Riwayat Transaksi - {{ current_user.username }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="bg-gradient-to-br from-[#7c4dff] to-[#5e35b1] text-white sticky top-0 z-50 shadow-md">
    <div class="container mx-auto px-6 py-4 flex items-center">
      <a href="{{ url_for('dashboard') }}" class="text-white text-2xl mr-4 hover:scale-105 transition-transform" title="Kembali ke Dashboard">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
      </a>
      <h1 class="text-xl font-semibold">Riwayat Transaksi</h1>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-6 py-8 max-w-5xl">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-6 space-y-2">
          {% for category, message in messages %}
            <div class="p-4 rounded-lg border-l-4 
              {% if category == 'success' %}bg-green-50 border-green-600 text-green-800
              {% else %}bg-red-50 border-red-600 text-red-800
              {% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Filter Section -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-5 flex items-center">
        <svg class="w-5 h-5 mr-2 text-[#7c4dff]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
        </svg>
        Filter Transaksi
      </h2>

      <form method="GET" action="{{ url_for('riwayat_siswa') }}" class="grid md:grid-cols-3 gap-4 mb-5">
        <div>
          <label for="filter_month" class="block text-sm font-medium text-gray-700 mb-1">Bulan</label>
          <select id="filter_month" name="filter_month" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#7c4dff] focus:border-[#7c4dff] bg-white">
            {% for num in range(1,13) %}
              <option value="{{ num }}" {% if filter_month == num %}selected{% endif %}>
                {{ "{:02d}".format(num) }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="filter_year" class="block text-sm font-medium text-gray-700 mb-1">Tahun</label>
          <select id="filter_year" name="filter_year" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#7c4dff] focus:border-[#7c4dff] bg-white">
            {% for year in range(2023, now.year+1) %}
              <option value="{{ year }}" {% if filter_year == year %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="flex gap-2 pt-5">
          <button type="submit" class="flex-1 px-4 py-2.5 bg-[#7c4dff] text-white font-medium rounded-lg hover:bg-[#5e35b1] transition-all">
            Filter
          </button>
          <a href="{{ url_for('riwayat_siswa') }}" class="px-4 py-2.5 bg-gray-500 text-white font-medium rounded-lg hover:bg-gray-600 transition-all">
            Reset
          </a>
        </div>
      </form>

      <!-- Filter Tipe Transaksi -->
      <div class="flex flex-wrap gap-2">
        <button type="button" class="filter-type-btn px-4 py-2 rounded-lg text-sm font-medium
          {% if selected_type_filter == 'all' %}bg-[#7c4dff] text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}"
          data-type="all">Semua</button>
        <button type="button" class="filter-type-btn px-4 py-2 rounded-lg text-sm font-medium
          {% if selected_type_filter == 'payment' %}bg-[#7c4dff] text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}"
          data-type="payment">Pembayaran</button>
        <button type="button" class="filter-type-btn px-4 py-2 rounded-lg text-sm font-medium
          {% if selected_type_filter == 'topup' %}bg-[#7c4dff] text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}"
          data-type="topup">Top Up</button>
        <button type="button" class="filter-type-btn px-4 py-2 rounded-lg text-sm font-medium
          {% if selected_type_filter == 'transfer' %}bg-[#7c4dff] text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}"
          data-type="transfer">Transfer</button>
      </div>
    </div>

    <!-- Rekap Saldo Bulanan -->
    {% if transactions %}
      <div class="bg-gradient-to-r from-[#7c4dff] to-[#9969ff] text-white rounded-xl p-5 mb-6 font-semibold text-lg">
        {{ bulan_ini }}: 
        <span class="ml-2 {% if total_bulan >= 0 %}text-green-100{% else %}text-red-100{% endif %}">
          {% if total_bulan >= 0 %}+{% endif %}{{ total_bulan|rupiah }}
        </span>
      </div>
    {% endif %}

    <!-- Daftar Transaksi -->
    <div class="space-y-3">
      {% if transactions %}
        {% for tx in transactions %}
          <a href="{{ url_for('detail_transaksi', transaksi_id=tx.id) }}" class="block">
            <div class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm hover:shadow-md transition-all duration-200">
              <div class="flex items-center justify-between">
                <!-- Kiri: Ikon & Detail -->
                <div class="flex items-center space-x-3 flex-1 min-w-0">
                  <!-- Ikon -->
                  <div class="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center flex-shrink-0">
                    {% if tx.type == 'payment' %}
                      <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                      </svg>
                    {% elif tx.type == 'topup' %}
                      <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7-4a4 4 0 014-4h6a4 4 0 014 4v6a4 4 0 01-4 4H8a4 4 0 01-4-4v-6z" />
                      </svg>
                    {% elif tx.type == 'transfer' %}
                      <svg class="w-5 h-5 text-[#7c4dff]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                      </svg>
                    {% endif %}
                  </div>

                  <!-- Detail -->
                  <div class="flex-1 min-w-0">
                    <h3 class="font-semibold text-gray-900 text-sm truncate">
                      {% if tx.type == 'payment' %}
                        {{ tx.related_user.username if tx.related_user else 'Penjual' }}
                      {% elif tx.type == 'topup' %}
                        TOP UP
                      {% elif tx.type == 'transfer' %}
                        {% if tx.user_id == current_user.id %}
                          Kirim ke {{ tx.related_user.username if tx.related_user else 'Pengguna' }}
                        {% elif tx.related_user_id == current_user.id %}
                          Terima dari {{ tx.user.username if tx.user else 'Pengguna' }}
                        {% endif %}
                      {% endif %}
                    </h3>
                    <p class="text-gray-500 text-xs">{{ tx.timestamp | wib }}</p>
                  </div>
                </div>

                <!-- Kanan: Nominal & Logo -->
                <div class="flex items-center space-x-3 flex-shrink-0">
                  <p class="font-semibold text-sm text-right
                    {% if tx.type == 'payment' or (tx.type == 'transfer' and tx.user_id == current_user.id) %}
                      text-red-600
                    {% else %}
                      text-green-600
                    {% endif %}">
                    {% if tx.type == 'payment' or (tx.type == 'transfer' and tx.user_id == current_user.id) %}-{% else %}+{% endif %}
                    {{ tx.amount|rupiah }}
                  </p>
                  <img src="{{ url_for('static', filename='images/hanya_logo.png') }}"
                       alt="Logo"
                       class="w-8 h-8 rounded-full"
                       draggable="false"
                       oncontextmenu="return false;">
                </div>
              </div>
            </div>
          </a>
        {% endfor %}
      {% else %}
        <div class="bg-white rounded-xl p-8 border border-gray-200 text-center shadow-sm">
          <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
          </div>
          <p class="text-gray-500 italic">Tidak ada transaksi ditemukan untuk periode atau filter yang dipilih.</p>
        </div>
      {% endif %}
    </div>

    <!-- Back to Dashboard -->
    <div class="mt-8 text-center">
      <a href="{{ url_for('dashboard') }}" class="inline-flex items-center text-[#7c4dff] hover:text-[#5e35b1] font-medium transition-colors">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Kembali ke Dashboard
      </a>
    </div>
  </main>
</div>

<!-- Filter Tipe Transaksi Script -->
<script>
document.querySelectorAll('.filter-type-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    const type = btn.getAttribute('data-type');
    const url = new URL(window.location);
    url.searchParams.set('filter_type', type);
    window.location.href = url.toString();
  });
});
</script>
{% endblock %}