{% extends 'base_siswa.html' %}

{% block content %}
<style>
    /* Animations not supported by Tailwind */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideIn {
        from { transform: translateY(-10px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .animate-slideIn {
        animation: slideIn 0.5s ease forwards;
    }

    .notif-backdrop {
        animation: fadeIn 0.3s ease;
    }
    .notification-icon-wrapper.active .notif-badge {
    display: none !important;
}
    .notif-badge {
    font-size: 0.45em !important;   /* Lebih kecil */
    padding: 2px 6px !important;    /* Padding kecil */
    min-width: 18px;
    height: 18px;
    line-height: 1.2;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    top: -2px;
    right: 0;
    }
    .history-preview-list li:hover {
    background: linear-gradient(90deg, #ede7f6 0%, #f3e5f5 100%);
    box-shadow: 0 4px 16px rgba(124,77,255,0.08);
    transform: scale(1.02);
    border-radius: 12px;
    transition: all 0.2s cubic-bezier(.4,2,.3,1);
}
.action-label[aria-disabled="true"] {
  pointer-events: none;
}
</style>

<div class="p-0">
    <div class="bg-gradient-to-br from-[#7c4dff] to-[#5e35b1] text-white p-5 md:p-[30px] rounded-b-[40px] flex justify-between items-center sticky top-0 z-[1000] shadow-[0_4px_20px_rgba(0,0,0,0.08)]">
        <div class="flex items-center gap-[15px]">
            <div class="profile-icon-header relative w-12 h-12 rounded-full flex items-center justify-center overflow-visible hover:scale-105 hover:shadow-[0_0_15px_rgba(255,255,255,0.3)]">
                {% if current_user.active_border %}
                    <div class="profile-border-overlay absolute -top-4 -left-[10px] -right-[10px] -bottom-[10px] z-[3] pointer-events-none flex items-center justify-center">
                        <img src="{{ url_for('static', filename=current_user.active_border.image_path) }}" alt="Border" class="border-overlay-img w-[55px] h-[55px] rounded-full object-cover pointer-events-none">
                    </div>
                {% endif %}
                {% if current_user.profile_pic_filename %}
                    <a href="{{ url_for('profile') }}">
                        <img src="{{ url_for('static', filename='profile_pics/' + current_user.profile_pic_filename) }}?v={{ range(1, 1000) | random }}" alt="P" class="profile-img-main w-12 h-12 rounded-full object-cover z-[2]">
                    </a>
                {% else %}
                    <i class="fas fa-user text-[22px] text-white"></i>
                {% endif %}
            </div>
            <div class="flex flex-col">
                <span class="greeting text-sm opacity-85 tracking-wider">Halo,</span>
                <span class="user-name text-lg font-semibold tracking-tight">{{ current_user.username }}{% if current_user.kelas and current_user.jurusan %} ({{ current_user.kelas }}-{{ current_user.jurusan }}){% endif %}</span>
            </div>
        </div>
        <div class="header-icons flex gap-5 items-center">
    <div class="notification-icon-wrapper relative z-[1100]">
        <a href="#" id="notif-bell-btn" title="Notifikasi" class="text-white text-2xl p-2 hover:text-[#ede7f6] transition-colors duration-300">
            <span class="icon-placeholder"><i class="fas fa-bell"></i></span>
            {% if unread_count > 0 and not notif_panel_active %}
                        <span class="notif-badge absolute -top-[2px] right-0 bg-red-600 text-white rounded-full px-[6px] py-[2px] text-[0.75em] md:text-[0.25em] font-semibold border-2 border-white shadow-[0_2px_10px_rgba(0,0,0,0.05)]">{{ unread_count if unread_count <= 9 else '9+' }}</span>
                    {% endif %}
                </a>
                <div id="notif-panel" class="notif-panel hidden absolute top-[calc(100%+12px)] -right-2.5 w-[280px] max-h-[70vh] overflow-y-auto bg-white rounded-xl shadow-[0_4px_20px_rgba(0,0,0,0.08)] border border-[#e8ecef] z-[1200] opacity-0 invisible -translate-y-2.5 transition-all duration-300">
                    <div class="notif-header p-4 font-semibold text-[#1a1a1a] border-b border-[#e8ecef] text-lg bg-white sticky top-0 z-[1]">Notifikasi Terbaru</div>
                    <ul class="notif-list p-0 m-0">
                        {% if recent_notifications and recent_notifications|length > 0 %}
                            {% for notif in recent_notifications %}
                                <li class="notif-item">
                                    <div class="p-4 text-[#1a1a1a]">
                                        <span class="font-semibold">{{ notif.type|capitalize }}</span>
                                        <br>
                                        <span class="text-sm text-[#666]">{{ notif.message }}</span>
                                        <br>
                                        <small class="text-[#666]">{{ notif.timestamp | wib }}</small>
                                    </div>
                                </li>
                            {% endfor %}
                        {% else %}
                            <li class="notif-item-empty p-[30px] text-center text-[#666] text-[0.95em]">Tidak ada notifikasi terbaru.</li>
                        {% endif %}
                    </ul>
                    <div class="notif-footer p-[10px_16px] text-center border-t border-[#e8ecef] bg-[#fafafa]">
                        <a href="{{ url_for('detail_notif') }}" class="text-[#7c4dff] no-underline text-[0.95em] font-medium hover:text-[#5e35b1] hover:underline transition-colors duration-200">Lihat Semua Notifikasi <i class="fas fa-arrow-right"></i></a>
                    </div>
                </div>
            </div>

            <!-- Pesan / Laporan icon (baru) -->
            <div class="message-icon-wrapper relative z-[1100]">
                <a href="{{ url_for('riwayat_pesan') }}" id="message-btn" title="Riwayat Laporan" class="text-white text-2xl p-2 hover:text-[#ede7f6] transition-colors duration-300">
                    <span class="icon-placeholder"><i class="fas fa-envelope"></i></span>
                    {% set pending_reports = current_user.laporan.filter_by(ditanggapi=False).count() if current_user.is_authenticated else 0 %}
                    {% if pending_reports and pending_reports > 0 %}
                        <span class="notif-badge absolute -top-[2px] right-0 bg-blue-500 text-white rounded-full px-[6px] py-[2px] text-[0.75em] md:text-[0.25em] font-semibold border-2 border-white shadow-[0_2px_10px_rgba(0,0,0,0.05)]">{{ pending_reports if pending_reports <= 9 else '9+' }}</span>
                    {% endif %}
                </a>
            </div>
        </div>
    </div>
    {% include 'partials/messages.html' %}


    <div class="balance-card bg-white mx-auto mt-[30px] rounded-[20px] p-6 w-[90%] max-w-[420px] shadow-[0_4px_20px_rgba(0,0,0,0.08)] relative hover:-translate-y-[5px] transition-transform duration-300 animate-slideIn md:w-[95%] md:mt-5">
        <div class="logo flex items-center gap-3 mb-5">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo DimasCash" class="h-[45px] w-auto">
        </div>
        <div class="balance-info flex justify-between items-center my-5 gap-5">
    <div class="balance-label text-2xl md:text-3xl font-bold text-[#1a1a1a] flex-grow flex items-center gap-2">
    <span id="saldo-text"><span id="saldo-rp">Rp</span><span id="saldo-angka">{{ "{:,.0f}".format(current_user.balance) }}</span></span>
    <button id="toggle-saldo" type="button" class="ml-2 focus:outline-none">
        <i id="eye-icon" class="fas fa-eye text-[#7c4dff] text-xl"></i>
    </button>
</div>
<div class="balance-actions flex justify-between gap-4">
    <a href="{{ url_for('request_topup') }}" 
       class="action-item flex flex-col items-center no-underline text-[#1a1a1a] hover:scale-105 transition-transform duration-300" 
       title="Info Top Up">
        <div class="action-icon bg-[#ede7f6] text-[#7c4dff] 
                    w-12 h-12 sm:w-14 sm:h-14   <!-- mobile kecil, sm ke atas normal -->
                    rounded-full flex justify-center items-center 
                    text-[18px] sm:text-[22px]  <!-- font icon juga mengecil di mobile -->
                    hover:bg-[#7c4dff] hover:text-white hover:shadow-[0_0_15px_rgba(124,77,255,0.3)] 
                    transition-all duration-300">
            <i class="fas fa-plus"></i>
        </div>
        <span class="action-label mt-2 text-[11px] sm:text-[13px] text-[#666] font-medium">Top up</span>
    </a>

    <a href="{{ url_for('transfer_user') }}" 
       class="action-item flex flex-col items-center no-underline text-[#1a1a1a] hover:scale-105 transition-transform duration-300" 
       title="Transfer/Kirim Saldo">
        <div class="action-icon bg-[#ede7f6] text-[#7c4dff] 
                    w-12 h-12 sm:w-14 sm:h-14
                    rounded-full flex justify-center items-center 
                    text-[18px] sm:text-[22px]
                    hover:bg-[#7c4dff] hover:text-white hover:shadow-[0_0_15px_rgba(124,77,255,0.3)] 
                    transition-all duration-300">
            <i class="fas fa-paper-plane"></i>
        </div>
        <span data-action="transfer" class="action-label mt-2 text-[11px] sm:text-[13px] text-[#666] font-medium">Kirim</span>
    </a>

    <a href="{{ url_for('pay_vendor') }}" 
       class="action-item flex flex-col items-center no-underline text-[#1a1a1a] hover:scale-105 transition-transform duration-300" 
       title="Bayar/Scan QR">
        <div class="action-icon bg-[#ede7f6] text-[#7c4dff] 
                    w-12 h-12 sm:w-14 sm:h-14
                    rounded-full flex justify-center items-center 
                    text-[18px] sm:text-[22px]
                    hover:bg-[#7c4dff] hover:text-white hover:shadow-[0_0_15px_rgba(124,77,255,0.3)] 
                    transition-all duration-300">
            <i class="fas fa-qrcode"></i>
        </div>
        <span data-action="pay" class="action-label mt-2 text-[11px] sm:text-[13px] text-[#666] font-medium">Bayar</span>
    </a>
</div>

        </div>
        <div class="spending-section bg-[#7c4dff] text-white p-4 rounded-xl mt-5 text-center text-base font-medium hover:bg-[#5e35b1] transition-colors duration-300">
            Pengeluaran Hari Ini: <strong class="font-bold">{{ todays_spending | rupiah }}</strong>
        </div>
    </div>

    {% set low_balance_threshold = 10000.0 %}
    {% if current_user.balance < low_balance_threshold and current_user.balance > 0 %}
        <div class="warning-section low-balance flex items-center gap-3 mx-auto my-5 p-[12px_16px] text-sm rounded-[10px] max-w-[90%] border border-[#ffecb5] shadow-[0_2px_10px_rgba(0,0,0,0.05)] text-[#664d03] bg-[#fff3cd] animate-slideIn">
            <div class="warning-icon text-[#ff9800] text-[26px]">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div>Saldo Anda hampir habis (tersisa {{ current_user.balance|rupiah }}). Segera lakukan Top Up!</div>
        </div>
    {% elif current_user.balance <= 0 %}
        <div class="warning-section zero-balance flex items-center gap-3 mx-auto my-5 p-[12px_16px] text-sm rounded-[10px] max-w-[90%] border border-[#f5c2c7] shadow-[0_2px_10px_rgba(0,0,0,0.05)] text-[#842029] bg-[#f8d7da] animate-slideIn">
            <div class="warning-icon text-[#dc3545] text-[26px]">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <div>Saldo Anda Habis (Rp 0). Harap lakukan Top Up.</div>
        </div>
    {% endif %}

    
        <!-- Berita banner (muncul jika ada latest_news) -->
        {% if latest_news and latest_news|length > 0 %}
        <div class="news-banner-container w-[90%] max-w-[900px] mx-auto my-6">
          <h4 class="text-lg font-semibold text-[#1a1a1a] mb-3">Berita Terbaru</h4>

          <style>
            /* Banner aspect ratio 21:9 and basic styling */
            .news-banner { position: relative; overflow: hidden; border-radius: 0.75rem; }
            .news-banner-inner { aspect-ratio: 21 / 9; width: 100%; height: auto; background:#f3f3f3; }
            .news-track { display: flex; height: 100%; will-change: transform; }
            .news-slide { flex: 0 0 100%; max-width: 100%; display:block; position:relative; }
            .news-slide .slide-media { width:100%; height:100%; display:block; object-fit:cover; }
            .news-controls { position:absolute; inset:0; pointer-events:none; }
            .news-btn { pointer-events:auto; background:rgba(255,255,255,0.92); border-radius:9999px; padding:0.5rem; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
            .news-prev, .news-next { position:absolute; top:50%; transform:translateY(-50%); z:20; }
            .news-prev { left:0.5rem; }
            .news-next { right:0.5rem; }
            .news-dots { position:absolute; left:50%; transform:translateX(-50%); bottom:0.5rem; display:flex; gap:0.5rem; z:20; }
            .news-dot { width:8px; height:8px; border-radius:9999px; background:rgba(255,255,255,0.7); cursor:pointer; border:1px solid rgba(0,0,0,0.05); }
            .news-dot.active { background:#7c4dff; box-shadow:0 2px 6px rgba(124,77,255,0.18); }
            .news-btn[disabled] { opacity:0.5; pointer-events:none; }
            @media (max-width:640px) {
              .news-btn { padding:0.4rem; }
              .news-dot { width:10px; height:10px; }
            }
          </style>

          <div class="news-banner">
            <div class="news-banner-inner" aria-hidden="false">
              <div id="news-track" class="news-track">
                {% for n in latest_news[:3] %}
                <a href="{{ url_for('berita_detail', news_id=n.id) }}" class="news-slide" role="group" aria-label="Slide {{ loop.index }}">
                  <img src="{{ url_for('static', filename='news/' + n.image_filename) }}" alt="{{ n.title }}" class="slide-media" />
                </a>
                {% endfor %}
              </div>
            </div>

            <div class="news-controls" aria-hidden="false">
              <div class="news-prev news-btn" title="Prev" id="news-prev-btn" aria-label="Previous slide">
                <i class="fas fa-chevron-left text-[#7c4dff]"></i>
              </div>
              <div class="news-next news-btn" title="Next" id="news-next-btn" aria-label="Next slide">
                <i class="fas fa-chevron-right text-[#7c4dff]"></i>
              </div>

              <div id="news-dots" class="news-dots" role="tablist" aria-label="Slide dots"></div>
            </div>
          </div>

<script>
(function(){
  const track = document.getElementById('news-track');
  if(!track) return;
  const prevBtn = document.getElementById('news-prev-btn');
  const nextBtn = document.getElementById('news-next-btn');
  const dotsContainer = document.getElementById('news-dots');

  let slides = Array.from(track.children);
  const originalCount = slides.length;

  if (originalCount <= 1) {
    if (prevBtn) prevBtn.setAttribute('disabled','');
    if (nextBtn) nextBtn.setAttribute('disabled','');
    track.style.transform = `translateX(0px)`;
    return;
  }

  const firstClone = slides[0].cloneNode(true);
  const lastClone  = slides[slides.length - 1].cloneNode(true);
  track.appendChild(firstClone);
  track.insertBefore(lastClone, track.firstChild);

  slides = Array.from(track.children);
  let index = 1;
  let slideWidth = 0;
  let autoTimer = null;
  const transitionMs = 500;
  const cooldownMs = transitionMs + 300; // jeda untuk mencegah rapid slide

  let isSliding = false;

  const dots = [];
  for (let i=0;i<originalCount;i++){
    const d = document.createElement('button');
    d.className = 'news-dot';
    d.type = 'button';
    d.setAttribute('aria-label','Go to slide '+(i+1));
    d.dataset.slide = i;
    dotsContainer.appendChild(d);
    dots.push(d);
    d.addEventListener('click', ()=> {
      if (isSliding) return;
      isSliding = true;
      disableControls();
      goToSlide(i);
      resetAuto();
      setTimeout(()=> { isSliding = false; enableControls(); }, cooldownMs);
    });
  }

  function setActiveDot() {
    const active = ((index - 1) % originalCount + originalCount) % originalCount;
    dots.forEach((d, i) => d.classList.toggle('active', i === active));
  }

  function updateSize() {
    const bannerInner = track.parentElement;
    slideWidth = bannerInner.getBoundingClientRect().width;
    track.style.transition = 'none';
    track.style.transform = `translateX(${-index * slideWidth}px)`;
    void track.offsetWidth;
    track.style.transition = `transform ${transitionMs}ms ease`;
  }

  function disableControls() {
    if (prevBtn) prevBtn.setAttribute('disabled','');
    if (nextBtn) nextBtn.setAttribute('disabled','');
  }
  function enableControls() {
    if (prevBtn) prevBtn.removeAttribute('disabled');
    if (nextBtn) nextBtn.removeAttribute('disabled');
  }

  function next() {
    if (isSliding) return;
    isSliding = true;
    disableControls();
    index++; moveTrack();
  }
  function prev() {
    if (isSliding) return;
    isSliding = true;
    disableControls();
    index--; moveTrack();
  }

  function moveTrack() {
    track.style.transition = `transform ${transitionMs}ms ease`;
    track.style.transform = `translateX(${-index * slideWidth}px)`;
    setActiveDot();
  }

  function goToSlide(n) {
    index = n + 1;
    moveTrack();
  }

  track.addEventListener('transitionend', ()=> {
    // jika berada pada clone di akhir -> snap ke nyata tanpa animasi
    if (index === slides.length - 1) {
      track.style.transition = 'none';
      index = 1;
      track.style.transform = `translateX(${-index * slideWidth}px)`;
      void track.offsetWidth;
      setTimeout(()=> { track.style.transition = `transform ${transitionMs}ms ease`; }, 20);
    }
    if (index === 0) {
      track.style.transition = 'none';
      index = slides.length - 2;
      track.style.transform = `translateX(${-index * slideWidth}px)`;
      void track.offsetWidth;
      setTimeout(()=> { track.style.transition = `transform ${transitionMs}ms ease`; }, 20);
    }
    setActiveDot();
    // selesai animasi utama -> beri jeda kecil sebelum mengizinkan interaksi lagi
    setTimeout(()=> { isSliding = false; enableControls(); }, 20);
  });

  nextBtn.addEventListener('click', ()=> { next(); resetAuto(); });
  prevBtn.addEventListener('click', ()=> { prev(); resetAuto(); });

  function startAuto(){ stopAuto(); autoTimer = setInterval(()=> { if(!isSliding){ next(); } }, 4000); }
  function stopAuto(){ if(autoTimer) clearInterval(autoTimer); autoTimer = null; }
  function resetAuto(){ stopAuto(); startAuto(); }

  window.addEventListener('load', ()=> {
    updateSize();
    setActiveDot();
    startAuto();
  });

  let resizeTimeout = null;
  window.addEventListener('resize', ()=> {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(()=> updateSize(), 80);
  });

  // swipe/touch handling with cooldown
  let startX = 0, deltaX = 0, isTouch = false;
  track.addEventListener('touchstart', (e) => {
    if (isSliding) return;
    stopAuto();
    isTouch = true;
    startX = e.touches[0].clientX;
    track.style.transition = 'none';
  }, {passive:true});
  track.addEventListener('touchmove', (e)=> {
    if(!isTouch) return;
    deltaX = e.touches[0].clientX - startX;
    track.style.transform = `translateX(${ -index * slideWidth + deltaX }px)`;
  }, {passive:true});
  track.addEventListener('touchend', ()=> {
    if (isSliding) { isTouch = false; deltaX = 0; resetAuto(); return; }
    isTouch = false;
    track.style.transition = `transform ${transitionMs}ms ease`;
    if (Math.abs(deltaX) > (slideWidth * 0.15)) {
      if (deltaX < 0) { next(); } else { prev(); }
    } else {
      track.style.transform = `translateX(${-index * slideWidth}px)`;
    }
    // beri cooldown sebelum memperbolehkan interaksi lagi
    setTimeout(()=> { isSliding = false; enableControls(); }, cooldownMs);
    deltaX = 0;
    resetAuto();
  });

  // keyboard accessibility
  track.parentElement.addEventListener('keydown', (e)=> {
    if(e.key === 'ArrowLeft') { prev(); resetAuto(); }
    if(e.key === 'ArrowRight') { next(); resetAuto(); }
  });

})();
</script>
        </div>
        {% endif %}


    <div class="history-preview-card bg-white rounded-[20px] w-[90%] max-w-[800px] mx-auto my-5 p-6 shadow-[0_4px_20px_rgba(0,0,0,0.08)] border border-[#e8ecef] relative hover:-translate-y-[5px] transition-transform duration-300 animate-slideIn md:w-[95%]">
        <h4 class="m-0 mb-[15px] text-lg font-semibold text-[#1a1a1a] border-b border-[#e8ecef] pb-3">Riwayat Terakhir</h4>
        {% if recent_transactions %}
            <ul class="history-preview-list p-0 m-0">
                {% for tx in recent_transactions[:3] %}
                <li class="flex justify-between items-center py-[14px] border-b border-[#e8ecef] last:border-b-0">
                    <div class="history-detail flex items-center gap-3">
                        {% if tx.type == 'payment' %}
                            <span class="icon payment text-[#e53935] text-2xl w-8 text-center"><i class="fas fa-store"></i></span>
                        {% elif tx.type == 'topup' %}
                            <span class="icon topup text-[#43a047] text-2xl w-8 text-center"><i class="fas fa-wallet"></i></span>
                        {% else %}
                            <span class="icon text-2xl w-8 text-center"><i class="fas fa-receipt"></i></span>
                        {% endif %}
                        <div>
                            {% if tx.user_id == current_user.id %}
                                {% if tx.type == 'payment' %} <span class="tx-desc font-medium text-[#1a1a1a] block">Bayar ke {{ tx.related_user.username if tx.related_user else 'N/A' }}</span>
                                {% elif tx.type == 'cashout_vendor' %} <span class="tx-desc font-medium text-[#1a1a1a] block">Cash Out ke Admin</span>
                                {% else %} <span class="tx-desc font-medium text-[#1a1a1a] block">{{ tx.type.capitalize() }}</span>
                                {% endif %}
                            {% elif tx.related_user_id == current_user.id %}
                                {% if tx.type == 'topup' %} <span class="tx-desc font-medium text-[#1a1a1a] block">Top Up dari Admin</span>
                                {% else %} <span class="tx-desc font-medium text-[#1a1a1a] block">{{ tx.type.capitalize() }} Diterima</span>
                                {% endif %}
                            {% endif %}
                            <span class="tx-time text-[0.85em] text-[#666]">{{ tx.timestamp | wib }}</span>
                        </div>
                    </div>
                    <div class="history-amount font-semibold whitespace-nowrap {% if tx.user_id == current_user.id and tx.type != 'topup' %}text-[#e53935]{% else %}text-[#43a047]{% endif %}">
                        {% if tx.user_id == current_user.id and tx.type != 'topup' %}-{% else %}+{% endif %}
                        {{ tx.amount|rupiah }}
                    </div>
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-center text-[#666] text-[0.9em] py-5">Belum ada transaksi terbaru.</p>
        {% endif %}
        {% if recent_transactions %}
        <a href="{{ url_for('riwayat_siswa') }}" class="view-all-history absolute bottom-[10px] right-5 text-[0.95em] text-[#7c4dff] no-underline font-medium hover:text-[#5e35b1] hover:underline transition-colors duration-200">Lihat Semua <i class="fas fa-arrow-right"></i></a>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const notifBellBtn = document.getElementById('notif-bell-btn');
    const notifPanel = document.getElementById('notif-panel');
    const notifBadge = document.querySelector('.notif-badge');
    const notifBackdrop = document.querySelector('.notif-backdrop');
    const notifWrapper = document.querySelector('.notification-icon-wrapper');
    const saldoAngka = document.getElementById('saldo-angka');
    const eyeIcon = document.getElementById('eye-icon');
    const toggleBtn = document.getElementById('toggle-saldo');
    let saldoVisible = true;
    const saldoAsli = saldoAngka.textContent;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    if (notifBellBtn && notifPanel && notifWrapper) {
        notifBellBtn.addEventListener('click', (event) => {
            event.preventDefault();
            if (!notifPanel) return;
            const isOpening = notifPanel.classList.contains('hidden');
            if (isOpening) {
                notifPanel.classList.remove('hidden', 'opacity-0', 'invisible');
                notifPanel.classList.add('active');
                if (notifBackdrop) notifBackdrop.classList.remove('hidden');
                notifWrapper.classList.add('active');
                fetch('/notifications/mark_read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });
                if (notifBadge) notifBadge.style.display = 'none';
            } else {
                notifPanel.classList.add('hidden', 'opacity-0', 'invisible');
                notifPanel.classList.remove('active');
                if (notifBackdrop) notifBackdrop.classList.add('hidden');
                notifWrapper.classList.remove('active');
            }
        });
    }

    if (localStorage.getItem('saldoVisible') === 'false') {
        saldoVisible = false;
        saldoAngka.textContent = '***';
        eyeIcon.classList.remove('fa-eye');
        eyeIcon.classList.add('fa-eye-slash');
    }

    toggleBtn.addEventListener('click', function() {
        saldoVisible = !saldoVisible;
        localStorage.setItem('saldoVisible', saldoVisible); // Simpan status ke localStorage
        if (saldoVisible) {
            saldoAngka.textContent = saldoAsli;
            eyeIcon.classList.remove('fa-eye-slash');
            eyeIcon.classList.add('fa-eye');
        } else {
            saldoAngka.textContent = '***';
            eyeIcon.classList.remove('fa-eye');
            eyeIcon.classList.add('fa-eye-slash');
        }
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  // Status lock dan pesan lock dari backend
  const appLocked = {{ 'true' if app_locked else 'false' }};
  if (!appLocked) return; // hanya aktifkan saat kondisi terkunci

  const lockMsg = {{ app_lock_message|tojson }};

  // Modal lock (hanya dibuat sekali)
  let lockModal = document.createElement('div');
  lockModal.id = 'app-lock-modal';
  lockModal.innerHTML = `
    <div style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:2000;">
      <div id="app-lock-backdrop" style="position:absolute;inset:0;background:rgba(0,0,0,0.5);"></div>
      <div role="dialog" aria-modal="true" style="position:relative;z-index:2001;max-width:420px;width:90%;background:#fff;border-radius:12px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.2);">
        <h3 style="margin:0 0 8px 0;font-size:18px;color:#7c4dff;">Informasi</h3>
        <p id="app-lock-message" style="margin:0 0 16px 0;color:#333;font-size:14px;"></p>
        <div style="text-align:right;">
          <button id="app-lock-close" style="background:#7c4dff;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;">Tutup</button>
        </div>
      </div>
    </div>
  `;
  lockModal.style.display = 'none';
  document.body.appendChild(lockModal);

  function showLockModal(msg){
    const modal = document.getElementById('app-lock-modal');
    const msgEl = modal.querySelector('#app-lock-message');
    msgEl.textContent = msg || lockMsg;
    modal.style.display = 'block';
    modal.querySelector('#app-lock-close').focus();
  }

  // Tutup modal jika klik backdrop/close atau tekan Escape
  document.body.addEventListener('click', function(e){
    if (e.target && (e.target.id === 'app-lock-close' || e.target.id === 'app-lock-backdrop')) {
      document.getElementById('app-lock-modal').style.display = 'none';
    }
  });
  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape') {
      const m = document.getElementById('app-lock-modal');
      if (m && m.style.display === 'block') m.style.display = 'none';
    }
  });

  // Disable tombol dan label "Kirim" & "Bayar"
  document.querySelectorAll('[data-action="pay"], [data-action="transfer"]').forEach(el => {
    const interactive = el.closest('a, button') || el;

    // Untuk anchor: simpan href asli lalu hapus href
    if (interactive.tagName.toLowerCase() === 'a') {
      interactive.dataset.origHref = interactive.getAttribute('href') || '';
      interactive.removeAttribute('href');
      interactive.setAttribute('role','button');
    }

    // Visual disable & aksesibilitas pada tombol
    interactive.classList.add('opacity-50', 'cursor-not-allowed');
    interactive.setAttribute('aria-disabled', 'true');
    try { interactive.tabIndex = -1; } catch(e){}

    // Visual disable & aksesibilitas pada label <span>
    el.classList.add('opacity-50', 'cursor-not-allowed');
    el.setAttribute('aria-disabled', 'true');
    el.setAttribute('title', lockMsg);

    // Jika user klik/memaksa, tampilkan modal pesan
    interactive.addEventListener('click', function(e){
      e.preventDefault();
      e.stopPropagation();
      showLockModal(lockMsg);
    }, { passive: false });

    // Tangani Enter/Space untuk aksesibilitas
    interactive.addEventListener('keydown', function(e){
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        showLockModal(lockMsg);
      }
    });
  });
});
</script>
{% endblock %}