{% extends 'base_siswa.html' %}

{% block content %}
<style>
    /* Animations not supported by Tailwind */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideIn {
        from { transform: translateY(-10px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .animate-slideIn {
        animation: slideIn 0.5s ease forwards;
    }

    .notif-backdrop {
        animation: fadeIn 0.3s ease;
    }
    .notification-icon-wrapper.active .notif-badge {
    display: none !important;
}
    .notif-badge {
    font-size: 0.45em !important;   /* Lebih kecil */
    padding: 2px 6px !important;    /* Padding kecil */
    min-width: 18px;
    height: 18px;
    line-height: 1.2;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    top: -2px;
    right: 0;
    }
    .history-preview-list li:hover {
    background: linear-gradient(90deg, #ede7f6 0%, #f3e5f5 100%);
    box-shadow: 0 4px 16px rgba(124,77,255,0.08);
    transform: scale(1.02);
    border-radius: 12px;
    transition: all 0.2s cubic-bezier(.4,2,.3,1);
}
</style>

<div class="p-0">
    <div class="bg-gradient-to-br from-[#7c4dff] to-[#5e35b1] text-white p-5 md:p-[30px] rounded-b-[40px] flex justify-between items-center sticky top-0 z-[1000] shadow-[0_4px_20px_rgba(0,0,0,0.08)]">
        <div class="flex items-center gap-[15px]">
            <div class="profile-icon-header relative w-12 h-12 rounded-full flex items-center justify-center overflow-visible hover:scale-105 hover:shadow-[0_0_15px_rgba(255,255,255,0.3)]">
                {% if current_user.active_border %}
                    <div class="profile-border-overlay absolute -top-4 -left-[10px] -right-[10px] -bottom-[10px] z-[3] pointer-events-none flex items-center justify-center">
                        <img src="{{ url_for('static', filename=current_user.active_border.image_path) }}" alt="Border" class="border-overlay-img w-[55px] h-[55px] rounded-full object-cover pointer-events-none">
                    </div>
                {% endif %}
                {% if current_user.profile_pic_filename %}
                    <a href="{{ url_for('profile') }}">
                        <img src="{{ url_for('static', filename='profile_pics/' + current_user.profile_pic_filename) }}?v={{ range(1, 1000) | random }}" alt="P" class="profile-img-main w-12 h-12 rounded-full object-cover z-[2]">
                    </a>
                {% else %}
                    <i class="fas fa-user text-[22px] text-white"></i>
                {% endif %}
            </div>
            <div class="flex flex-col">
                <span class="greeting text-sm opacity-85 tracking-wider">Halo,</span>
                <span class="user-name text-lg font-semibold tracking-tight">{{ current_user.username }}{% if current_user.kelas and current_user.jurusan %} ({{ current_user.kelas }}-{{ current_user.jurusan }}){% endif %}</span>
            </div>
        </div>
        <div class="header-icons flex gap-5 items-center">
    <div class="notification-icon-wrapper relative z-[1100]">
        <a href="#" id="notif-bell-btn" title="Notifikasi" class="text-white text-2xl p-2 hover:text-[#ede7f6] transition-colors duration-300">
            <span class="icon-placeholder"><i class="fas fa-bell"></i></span>
            {% if unread_count > 0 and not notif_panel_active %}
                        <span class="notif-badge absolute -top-[2px] right-0 bg-red-600 text-white rounded-full px-[6px] py-[2px] text-[0.75em] md:text-[0.25em] font-semibold border-2 border-white shadow-[0_2px_10px_rgba(0,0,0,0.05)]">{{ unread_count if unread_count <= 9 else '9+' }}</span>
                    {% endif %}
                </a>
                <div id="notif-panel" class="notif-panel hidden absolute top-[calc(100%+12px)] -right-2.5 w-[280px] max-h-[70vh] overflow-y-auto bg-white rounded-xl shadow-[0_4px_20px_rgba(0,0,0,0.08)] border border-[#e8ecef] z-[1200] opacity-0 invisible -translate-y-2.5 transition-all duration-300">
                    <div class="notif-header p-4 font-semibold text-[#1a1a1a] border-b border-[#e8ecef] text-lg bg-white sticky top-0 z-[1]">Notifikasi Terbaru</div>
                    <ul class="notif-list p-0 m-0">
                        {% if recent_notifications and recent_notifications|length > 0 %}
                            {% for notif in recent_notifications %}
                                <li class="notif-item">
                                    <div class="p-4 text-[#1a1a1a]">
                                        <span class="font-semibold">{{ notif.type|capitalize }}</span>
                                        <br>
                                        <span class="text-sm text-[#666]">{{ notif.message }}</span>
                                        <br>
                                        <small class="text-[#666]">{{ notif.timestamp | wib }}</small>
                                    </div>
                                </li>
                            {% endfor %}
                        {% else %}
                            <li class="notif-item-empty p-[30px] text-center text-[#666] text-[0.95em]">Tidak ada notifikasi terbaru.</li>
                        {% endif %}
                    </ul>
                    <div class="notif-footer p-[10px_16px] text-center border-t border-[#e8ecef] bg-[#fafafa]">
                        <a href="{{ url_for('detail_notif') }}" class="text-[#7c4dff] no-underline text-[0.95em] font-medium hover:text-[#5e35b1] hover:underline transition-colors duration-200">Lihat Semua Notifikasi <i class="fas fa-arrow-right"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="balance-card bg-white mx-auto mt-[30px] rounded-[20px] p-6 w-[90%] max-w-[420px] shadow-[0_4px_20px_rgba(0,0,0,0.08)] relative hover:-translate-y-[5px] transition-transform duration-300 animate-slideIn md:w-[95%] md:mt-5">
        <div class="logo flex items-center gap-3 mb-5">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo DimasCash" class="h-[45px] w-auto">
        </div>
        <div class="balance-info flex justify-between items-center my-5 gap-5">
    <div class="balance-label text-2xl md:text-3xl font-bold text-[#1a1a1a] flex-grow flex items-center gap-2">
    <span id="saldo-text"><span id="saldo-rp">Rp</span><span id="saldo-angka">{{ "{:,.0f}".format(current_user.balance) }}</span></span>
    <button id="toggle-saldo" type="button" class="ml-2 focus:outline-none">
        <i id="eye-icon" class="fas fa-eye text-[#7c4dff] text-xl"></i>
    </button>
</div>
<div class="balance-actions flex justify-between gap-4">
    <a href="{{ url_for('request_topup') }}" 
       class="action-item flex flex-col items-center no-underline text-[#1a1a1a] hover:scale-105 transition-transform duration-300" 
       title="Info Top Up">
        <div class="action-icon bg-[#ede7f6] text-[#7c4dff] 
                    w-12 h-12 sm:w-14 sm:h-14   <!-- mobile kecil, sm ke atas normal -->
                    rounded-full flex justify-center items-center 
                    text-[18px] sm:text-[22px]  <!-- font icon juga mengecil di mobile -->
                    hover:bg-[#7c4dff] hover:text-white hover:shadow-[0_0_15px_rgba(124,77,255,0.3)] 
                    transition-all duration-300">
            <i class="fas fa-plus"></i>
        </div>
        <span class="action-label mt-2 text-[11px] sm:text-[13px] text-[#666] font-medium">Top up</span>
    </a>

    <a href="{{ url_for('transfer_user') }}" 
       class="action-item flex flex-col items-center no-underline text-[#1a1a1a] hover:scale-105 transition-transform duration-300" 
       title="Transfer/Kirim Saldo">
        <div class="action-icon bg-[#ede7f6] text-[#7c4dff] 
                    w-12 h-12 sm:w-14 sm:h-14
                    rounded-full flex justify-center items-center 
                    text-[18px] sm:text-[22px]
                    hover:bg-[#7c4dff] hover:text-white hover:shadow-[0_0_15px_rgba(124,77,255,0.3)] 
                    transition-all duration-300">
            <i class="fas fa-paper-plane"></i>
        </div>
        <span class="action-label mt-2 text-[11px] sm:text-[13px] text-[#666] font-medium">Kirim</span>
    </a>

    <a href="{{ url_for('pay_vendor') }}" 
       class="action-item flex flex-col items-center no-underline text-[#1a1a1a] hover:scale-105 transition-transform duration-300" 
       title="Bayar/Scan QR">
        <div class="action-icon bg-[#ede7f6] text-[#7c4dff] 
                    w-12 h-12 sm:w-14 sm:h-14
                    rounded-full flex justify-center items-center 
                    text-[18px] sm:text-[22px]
                    hover:bg-[#7c4dff] hover:text-white hover:shadow-[0_0_15px_rgba(124,77,255,0.3)] 
                    transition-all duration-300">
            <i class="fas fa-qrcode"></i>
        </div>
        <span class="action-label mt-2 text-[11px] sm:text-[13px] text-[#666] font-medium">Bayar</span>
    </a>
</div>

        </div>
        <div class="spending-section bg-[#7c4dff] text-white p-4 rounded-xl mt-5 text-center text-base font-medium hover:bg-[#5e35b1] transition-colors duration-300">
            Pengeluaran Hari Ini: <strong class="font-bold">{{ todays_spending | rupiah }}</strong>
        </div>
    </div>

    {% set low_balance_threshold = 10000.0 %}
    {% if current_user.balance < low_balance_threshold and current_user.balance > 0 %}
        <div class="warning-section low-balance flex items-center gap-3 mx-auto my-5 p-[12px_16px] text-sm rounded-[10px] max-w-[90%] border border-[#ffecb5] shadow-[0_2px_10px_rgba(0,0,0,0.05)] text-[#664d03] bg-[#fff3cd] animate-slideIn">
            <div class="warning-icon text-[#ff9800] text-[26px]">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div>Saldo Anda hampir habis (tersisa {{ current_user.balance|rupiah }}). Segera lakukan Top Up!</div>
        </div>
    {% elif current_user.balance <= 0 %}
        <div class="warning-section zero-balance flex items-center gap-3 mx-auto my-5 p-[12px_16px] text-sm rounded-[10px] max-w-[90%] border border-[#f5c2c7] shadow-[0_2px_10px_rgba(0,0,0,0.05)] text-[#842029] bg-[#f8d7da] animate-slideIn">
            <div class="warning-icon text-[#dc3545] text-[26px]">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <div>Saldo Anda Habis (Rp 0). Harap lakukan Top Up.</div>
        </div>
    {% endif %}

    <div class="history-preview-card bg-white rounded-[20px] w-[90%] max-w-[800px] mx-auto my-5 p-6 shadow-[0_4px_20px_rgba(0,0,0,0.08)] border border-[#e8ecef] relative hover:-translate-y-[5px] transition-transform duration-300 animate-slideIn md:w-[95%]">
        <h4 class="m-0 mb-[15px] text-lg font-semibold text-[#1a1a1a] border-b border-[#e8ecef] pb-3">Riwayat Terakhir</h4>
        {% if recent_transactions %}
            <ul class="history-preview-list p-0 m-0">
                {% for tx in recent_transactions[:3] %}
                <li class="flex justify-between items-center py-[14px] border-b border-[#e8ecef] last:border-b-0">
                    <div class="history-detail flex items-center gap-3">
                        {% if tx.type == 'payment' %}
                            <span class="icon payment text-[#e53935] text-2xl w-8 text-center"><i class="fas fa-store"></i></span>
                        {% elif tx.type == 'topup' %}
                            <span class="icon topup text-[#43a047] text-2xl w-8 text-center"><i class="fas fa-wallet"></i></span>
                        {% else %}
                            <span class="icon text-2xl w-8 text-center"><i class="fas fa-receipt"></i></span>
                        {% endif %}
                        <div>
                            {% if tx.user_id == current_user.id %}
                                {% if tx.type == 'payment' %} <span class="tx-desc font-medium text-[#1a1a1a] block">Bayar ke {{ tx.related_user.username if tx.related_user else 'N/A' }}</span>
                                {% elif tx.type == 'cashout_vendor' %} <span class="tx-desc font-medium text-[#1a1a1a] block">Cash Out ke Admin</span>
                                {% else %} <span class="tx-desc font-medium text-[#1a1a1a] block">{{ tx.type.capitalize() }}</span>
                                {% endif %}
                            {% elif tx.related_user_id == current_user.id %}
                                {% if tx.type == 'topup' %} <span class="tx-desc font-medium text-[#1a1a1a] block">Top Up dari Admin</span>
                                {% else %} <span class="tx-desc font-medium text-[#1a1a1a] block">{{ tx.type.capitalize() }} Diterima</span>
                                {% endif %}
                            {% endif %}
                            <span class="tx-time text-[0.85em] text-[#666]">{{ tx.timestamp | wib }}</span>
                        </div>
                    </div>
                    <div class="history-amount font-semibold whitespace-nowrap {% if tx.user_id == current_user.id and tx.type != 'topup' %}text-[#e53935]{% else %}text-[#43a047]{% endif %}">
                        {% if tx.user_id == current_user.id and tx.type != 'topup' %}-{% else %}+{% endif %}
                        {{ tx.amount|rupiah }}
                    </div>
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-center text-[#666] text-[0.9em] py-5">Belum ada transaksi terbaru.</p>
        {% endif %}
        {% if recent_transactions %}
        <a href="{{ url_for('riwayat_siswa') }}" class="view-all-history absolute bottom-[10px] right-5 text-[0.95em] text-[#7c4dff] no-underline font-medium hover:text-[#5e35b1] hover:underline transition-colors duration-200">Lihat Semua <i class="fas fa-arrow-right"></i></a>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const notifBellBtn = document.getElementById('notif-bell-btn');
    const notifPanel = document.getElementById('notif-panel');
    const notifBadge = document.querySelector('.notif-badge');
    const notifBackdrop = document.querySelector('.notif-backdrop');
    const notifWrapper = document.querySelector('.notification-icon-wrapper');
    const saldoAngka = document.getElementById('saldo-angka');
    const eyeIcon = document.getElementById('eye-icon');
    const toggleBtn = document.getElementById('toggle-saldo');
    let saldoVisible = true;
    const saldoAsli = saldoAngka.textContent;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    if (notifBellBtn && notifPanel && notifWrapper) {
        notifBellBtn.addEventListener('click', (event) => {
            event.preventDefault();
            if (!notifPanel) return;
            const isOpening = notifPanel.classList.contains('hidden');
            if (isOpening) {
                notifPanel.classList.remove('hidden', 'opacity-0', 'invisible');
                notifPanel.classList.add('active');
                if (notifBackdrop) notifBackdrop.classList.remove('hidden');
                notifWrapper.classList.add('active');
                fetch('/notifications/mark_read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });
                if (notifBadge) notifBadge.style.display = 'none';
            } else {
                notifPanel.classList.add('hidden', 'opacity-0', 'invisible');
                notifPanel.classList.remove('active');
                if (notifBackdrop) notifBackdrop.classList.add('hidden');
                notifWrapper.classList.remove('active');
            }
        });
    }

    if (localStorage.getItem('saldoVisible') === 'false') {
        saldoVisible = false;
        saldoAngka.textContent = '***';
        eyeIcon.classList.remove('fa-eye');
        eyeIcon.classList.add('fa-eye-slash');
    }

    toggleBtn.addEventListener('click', function() {
        saldoVisible = !saldoVisible;
        localStorage.setItem('saldoVisible', saldoVisible); // Simpan status ke localStorage
        if (saldoVisible) {
            saldoAngka.textContent = saldoAsli;
            eyeIcon.classList.remove('fa-eye-slash');
            eyeIcon.classList.add('fa-eye');
        } else {
            saldoAngka.textContent = '***';
            eyeIcon.classList.remove('fa-eye');
            eyeIcon.classList.add('fa-eye-slash');
        }
    });
});
</script>
{% endblock %}