{% extends 'base_siswa.html' %}
{% block title %}Lakukan Pembayaran - DimasCash{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="bg-gradient-to-br from-[#7c4dff] to-[#5e35b1] text-white sticky top-0 z-50 shadow-md">
    <div class="container mx-auto px-6 py-4 flex items-center">
      <a href="{{ url_for('dashboard') }}" class="text-white text-2xl mr-4 hover:scale-105 transition-transform" title="Kembali ke Dashboard">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
      </a>
      <h1 class="text-xl font-semibold">Lakukan Pembayaran</h1>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-6 py-8 max-w-4xl">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-6 space-y-2">
          {% for category, message in messages %}
            <div class="p-4 rounded-lg border-l-4 
              {% if category == 'success' %}bg-green-50 border-green-600 text-green-800
              {% else %}bg-red-50 border-red-600 text-red-800
              {% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Payment Card -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden transition-transform hover:-translate-y-1 duration-300">
      <div class="p-6 border-b border-gray-200">
        <h2 class="text-2xl font-bold text-gray-900 flex items-center">
          <svg class="w-6 h-6 mr-2 text-[#7c4dff]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7-4a4 4 0 014-4h6a4 4 0 014 4v6a4 4 0 01-4 4H8a4 4 0 01-4-4v-6z" />
          </svg>
          Lakukan Pembayaran
        </h2>
      </div>

      <div class="p-6 grid md:grid-cols-2 gap-8">
        <!-- QR Scan Section -->
        <div class="space-y-5">
          <div class="text-lg font-medium text-gray-800">
            Saldo Anda: <span class="font-bold text-[#7c4dff]">{{ current_user.balance|rupiah }}</span>
          </div>

          <h3 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2 flex items-center">
            <svg class="w-5 h-5 mr-2 text-[#7c4dff]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
            </svg>
            Scan Kode QR Penjual
          </h3>

          <button id="start-scan-btn" type="button"
                  class="w-full py-3 bg-gradient-to-r from-[#7c4dff] to-[#9969ff] text-white font-semibold rounded-lg shadow-sm hover:from-[#6a3de8] hover:to-[#7c4dff] transition-all focus:outline-none focus:ring-2 focus:ring-[#7c4dff]/50">
            Mulai Scan
          </button>

          <div id="qr-reader" class="w-64 h-64 mx-auto mt-5 border-2 border-dashed border-gray-300 rounded-xl overflow-hidden hidden"></div>

          <div id="qr-scan-result" class="mt-4 text-sm text-center text-gray-600 min-h-6"></div>
        </div>

        <!-- Manual Payment Form -->
        <div class="payment-form">
          <h3 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2 flex items-center">
            <svg class="w-5 h-5 mr-2 text-[#7c4dff]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
            Pilih Penjual Manual
          </h3>

          <form method="POST" action="{{ url_for('pay_vendor') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <!-- Vendor -->
            <div class="mb-5">
              <label for="vendor_id" class="block text-sm font-medium text-gray-700 mb-1">Bayar Ke</label>
              <select name="vendor_id" id="vendor_id" required
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-[#7c4dff] focus:border-[#7c4dff] appearance-none">
                <option value="" disabled selected>-- Pilih Penjual --</option>
                {% for vendor in vendors %}
                  <option value="{{ vendor.id }}">{{ vendor.username }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Amount -->
            <div class="mb-5">
              <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Pembayaran (Rp)</label>
              <input type="number" name="amount" id="amount" min="100" step="any" required placeholder="Masukkan jumlah"
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-[#7c4dff] focus:border-[#7c4dff]" />
            </div>

            <!-- Submit -->
            <button type="submit"
                    class="w-full py-3 bg-gradient-to-r from-[#7c4dff] to-[#9969ff] text-white font-semibold rounded-lg shadow-sm hover:from-[#6a3de8] hover:to-[#7c4dff] transition-all focus:outline-none focus:ring-2 focus:ring-[#7c4dff]/50">
              Bayar Sekarang
            </button>
          </form>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Load html5-qrcode dari CDN -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
const vendorSelect = document.getElementById('vendor_id');
const qrReaderDiv = document.getElementById('qr-reader');
const scanBtn = document.getElementById('start-scan-btn');
const resultDiv = document.getElementById('qr-scan-result');
let html5QrCode = null;

function isScanning() {
  return scanBtn.textContent === 'Hentikan Scan';
}

function onScanSuccess(decodedText, decodedResult) {
  console.log(`Hasil Scan: ${decodedText}`);
  resultDiv.innerHTML = `Memproses ID: ${decodedText}...`;

  let vendorFound = false;
  for (let i = 0; i < vendorSelect.options.length; i++) {
    if (vendorSelect.options[i].value === decodedText) {
      vendorSelect.selectedIndex = i;
      vendorFound = true;
      break;
    }
  }

  if (vendorFound) {
    resultDiv.innerHTML = `<span class="text-green-600">✔ Penjual '${vendorSelect.options[vendorSelect.selectedIndex].text}' terpilih! Masukkan jumlah.</span>`;
    document.getElementById('amount').focus();
    stopScanning();
  } else {
    resultDiv.innerHTML = `<span class="text-red-600">✖ QR tidak cocok. Pilih manual atau scan ulang.</span>`;
  }
}

function onScanFailure(error) {
  // Abaikan error scan
}

async function startScanning() {
  if (!html5QrCode) {
    html5QrCode = new Html5Qrcode("qr-reader");
  }

  qrReaderDiv.style.display = 'block';
  resultDiv.innerHTML = 'Arahkan kamera ke Kode QR Penjual...';
  scanBtn.textContent = 'Hentikan Scan';

  try {
    const devices = await Html5Qrcode.getCameras();
    if (devices && devices.length > 0) {
      const config = {
        fps: 10,
        qrbox: { width: 200, height: 200 },
        aspectRatio: 1.0
      };
      await html5QrCode.start(
        { facingMode: "environment" },
        config,
        onScanSuccess,
        onScanFailure
      );
    } else {
      throw new Error('Tidak ada kamera yang tersedia');
    }
  } catch (err) {
    console.error("Error starting scanner:", err);
    resultDiv.innerHTML = `<span class="text-red-600">Error kamera: ${err.message || err}. Izinkan akses kamera.</span>`;
    qrReaderDiv.style.display = 'none';
    scanBtn.textContent = 'Mulai Scan';
  }
}

async function stopScanning() {
  if (html5QrCode) {
    try {
      await html5QrCode.stop();
    } catch (err) {
      console.warn("Error stopping scanner:", err);
    }
    html5QrCode = null;
  }
  qrReaderDiv.style.display = 'none';
  scanBtn.textContent = 'Mulai Scan';
}

// Event listener
scanBtn.addEventListener('click', () => {
  if (isScanning()) {
    stopScanning();
  } else {
    startScanning();
  }
});
</script>
{% endblock %}