{% extends 'base_siswa.html' %}
{% block content %}
<div class="min-h-screen bg-gray-50">
  <!-- Header -->
  <header class="bg-gradient-to-br from-[#7c4dff] to-[#5e35b1] text-white sticky top-0 z-50 shadow-md">
    <div class="container mx-auto px-6 py-4 flex items-center">
      <a href="{{ url_for('dashboard') }}" class="text-white text-2xl mr-4 hover:scale-105 transition-transform" title="Kembali ke Dashboard">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
      </a>
      <h1 class="text-xl font-semibold">Transfer Saldo</h1>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-6 py-8 max-w-lg">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-6 space-y-2">
          {% for category, message in messages %}
            <div class="p-4 rounded-lg border-l-4 
              {% if category == 'success' %}bg-green-50 border-green-600 text-green-800
              {% elif category == 'danger' %}bg-red-50 border-red-600 text-red-800
              {% else %}bg-yellow-50 border-yellow-600 text-yellow-800
              {% endif %} animate-fade-in">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Main Form Card -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-6">
      <h2 class="text-xl font-bold text-gray-900 mb-5 flex items-center">
        <svg class="w-5 h-5 mr-2 text-[#7c4dff]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
        </svg>
        Form Transfer
      </h2>

      <form method="POST" id="transfer-form" class="space-y-5">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" id="current-user-id" value="{{ current_user.id }}">
        <input type="hidden" id="user-balance" value="{{ saldo_user }}">

        <!-- ID Tujuan Section -->
        <div>
          <label for="target_id" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
            <svg class="w-5 h-5 mr-2 text-[#7c4dff]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            ID Tujuan
          </label>
          <div class="relative">
            <input type="text" name="target_id" id="target_id" required 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#7c4dff] focus:border-[#7c4dff] bg-white font-mono text-base"
                   placeholder="Masukkan ID tujuan atau scan QR">
            <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
              <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
            </div>
          </div>

          <!-- Preview Tujuan -->
          <div id="preview-tujuan" class="mt-3 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden animate-fade-in">
            <div class="flex items-center">
              <div class="relative w-12 h-12 mr-3 flex items-center justify-center" id="tujuan-photo-wrapper">
                <img id="tujuan-photo" src="" alt="Foto Profil" class="absolute w-10 h-10 object-cover rounded-full z-10" style="display:none; left:6px; top:6px;">
                <span id="tujuan-initial" class="absolute w-10 h-10 font-semibold text-white text-sm bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center z-10" style="left:6px; top:6px;"></span>
                <img id="tujuan-border" src="" alt="Border" class="absolute w-full h-full object-cover rounded-full z-20" style="display:none; left:0; top:0;">
              </div>
              <div>
                <p class="text-sm font-medium text-blue-800">Tujuan Transfer:</p>
                <p class="text-base font-semibold text-blue-900" id="tujuan-username">-</p>
              </div>
            </div>
          </div>

          <!-- QR Scanner Button -->
          <button type="button" id="scan-btn" 
                  class="mt-3 w-full py-3 bg-[#7c4dff] text-white font-medium rounded-lg hover:bg-[#5e35b1] transition focus:outline-none focus:ring-2 focus:ring-[#7c4dff]/50 flex items-center justify-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
            </svg>
            Scan QR Code
          </button>

          <!-- QR Reader Container -->
          <div id="qr-reader" class="mt-3 hidden rounded-lg overflow-hidden shadow-lg"></div>
        </div>

        <!-- Jumlah Transfer Section -->
        <div>
          <label for="amount" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
            <svg class="w-5 h-5 mr-2 text-[#7c4dff]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
            </svg>
            Jumlah Transfer
          </label>
          <div class="relative">
            <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">Rp</div>
            <input type="number" name="amount" id="amount" min="100" required 
                   class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#7c4dff] focus:border-[#7c4dff] bg-white text-base"
                   placeholder="0">
          </div>
          <div id="amount-warning" class="text-red-600 text-sm mt-2" style="display:none;"></div>
          <p class="text-xs text-gray-500 mt-2 flex items-center">
            <svg class="w-4 h-4 mr-1 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
            </svg>
            Minimal transfer Rp 5.000
          </p>
        </div>

        <!-- Submit Button -->
        <button type="button" id="submit-btn"
                class="w-full py-3 bg-gradient-to-r from-[#7c4dff] to-[#9969ff] text-white font-semibold rounded-lg shadow-sm hover:from-[#6a3de8] hover:to-[#7c4dff] transition focus:outline-none focus:ring-2 focus:ring-[#7c4dff]/50">
          <svg class="w-5 h-5 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
          </svg>
          Kirim Transfer
        </button>
      </form>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed left-0 top-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center p-4 z-[10000] hidden">
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 max-w-md w-full animate-bounce-in">
        <div class="bg-gradient-to-r from-[#7c4dff] to-[#5e35b1] px-6 py-4 rounded-t-xl">
          <h3 class="text-lg font-semibold text-white flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            Konfirmasi Transfer
          </h3>
        </div>
        <div class="p-6">
          <div class="text-center mb-6">
            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
              </svg>
            </div>
            <p class="text-lg font-semibold text-gray-800 mb-2">Yakin ingin melakukan transfer?</p>
            <div class="bg-gray-50 rounded-lg p-4 space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600">Kepada:</span>
                <span class="font-medium text-gray-800" id="modal-username">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">ID Tujuan:</span>
                <span class="font-medium text-gray-800 font-mono" id="modal-target-id">-</span>
              </div>
              <div class="flex justify-between border-t pt-2">
                <span class="text-gray-600">Jumlah:</span>
                <span class="font-semibold text-[#7c4dff]" id="modal-amount">-</span>
              </div>
            </div>
          </div>
          <div class="flex space-x-3">
            <button type="button" id="cancel-btn" 
                    class="flex-1 py-3 bg-gray-500 text-white font-medium rounded-lg hover:bg-gray-600 transition focus:outline-none focus:ring-2 focus:ring-gray-500/50">
              <svg class="w-5 h-5 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
              Batal
            </button>
            <button type="button" id="confirm-btn" 
                    class="flex-1 py-3 bg-gradient-to-r from-[#7c4dff] to-[#9969ff] text-white font-medium rounded-lg hover:from-[#6a3de8] hover:to-[#7c4dff] transition focus:outline-none focus:ring-2 focus:ring-[#7c4dff]/50">
              <svg class="w-5 h-5 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              Ya, Transfer
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- PIN Modal -->
    <div id="pin-modal" class="fixed left-0 top-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center p-4 z-[10001] hidden">
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 max-w-sm w-full p-6 text-center">
        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center justify-center">
          <svg class="w-5 h-5 mr-2 text-[#7c4dff]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0-1.1-.9-2-2-2s-2 .9-2 2v2h4v-2zm-2 5a2 2 0 100-4 2 2 0 000 4zM5 15v5h14v-5H5zm0-2h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v5a2 2 0 002 2z"></path>
          </svg>
          Masukkan PIN Transfer
        </h3>
        <input type="password" id="input-pin" maxlength="6" pattern="\d{6}" 
               class="w-full p-3 border border-gray-300 rounded-lg text-lg text-center tracking-widest mb-4 focus:ring-2 focus:ring-[#7c4dff] focus:border-[#7c4dff]"
               placeholder="••••••" required>
        <div id="pin-warning" class="text-red-600 text-sm mb-4" style="display:none;"></div>
        <button type="button" id="pin-submit-btn" 
                class="w-full py-3 bg-gradient-to-r from-[#7c4dff] to-[#9969ff] text-white font-medium rounded-lg hover:from-[#6a3de8] hover:to-[#7c4dff] transition focus:outline-none focus:ring-2 focus:ring-[#7c4dff]/50">
          Lanjutkan Transfer
        </button>
      </div>
    </div>
  </main>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
let qrCodeScanner = null;
let scrollPosition = 0;

// QR Code Scanner
document.getElementById('scan-btn').onclick = async function() {
    const qrReader = document.getElementById('qr-reader');
    const scanBtn = document.getElementById('scan-btn');

    if (qrCodeScanner) {
        try {
            await qrCodeScanner.stop();
        } catch (stopErr) {
            console.warn('qrCodeScanner.stop() error (ignored):', stopErr);
            try { await qrCodeScanner.clear(); } catch(e){ /* ignore */ }
        } finally {
            qrReader.classList.add('hidden');
            scanBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                </svg>
                Scan QR Code
            `;
            qrCodeScanner = null;
        }
        return;
    }

    qrReader.classList.remove('hidden');
    scanBtn.innerHTML = `
        <svg class="w-5 h-5 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
        Berhenti Scan
    `;

    qrCodeScanner = new Html5Qrcode("qr-reader");

    const startOptions = { fps: 10, qrbox: { width: 200, height: 200 } };

    let started = false;
    try {
        const cams = await Html5Qrcode.getCameras();
        if (cams && cams.length) {
            const preferred = cams.find(c => /back|rear|environment/i.test(c.label)) || cams[0];
            try {
                await qrCodeScanner.start(preferred.id, startOptions,
                    (decodedText) => {
                        document.getElementById('target_id').value = decodedText;
                        fetchUsername(decodedText);
                        qrCodeScanner.stop().catch(err => {
                            console.warn('stop() after decode error (ignored):', err);
                            try { qrCodeScanner.clear(); } catch(e){/*ignore*/ }
                        }).finally(() => {
                            qrReader.classList.add('hidden');
                            scanBtn.innerHTML = `
                                <svg class="w-5 h-5 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                                </svg>
                                Scan QR Code
                            `;
                            qrCodeScanner = null;
                        });
                    },
                    (errorMessage) => { /* ignore frequent scan errors */ }
                );
                started = true;
            } catch (err) {
                console.warn('Failed to start with deviceId, will try fallbacks', err);
            }
        }
    } catch (err) {
        console.warn('getCameras() failed or not supported, will try fallbacks', err);
    }

    if (!started) {
        const fallbacks = [
            "environment",
            { facingMode: { exact: "environment" } },
            "user"
        ];

        for (const cfg of fallbacks) {
            try {
                await qrCodeScanner.start(
                    cfg,
                    startOptions,
                    (decodedText) => {
                        document.getElementById('target_id').value = decodedText;
                        fetchUsername(decodedText);
                        qrCodeScanner.stop().catch(err => {
                            console.warn('stop() after decode error (ignored):', err);
                            try { qrCodeScanner.clear(); } catch(e){/*ignore*/ }
                        }).finally(() => {
                            qrReader.classList.add('hidden');
                            scanBtn.innerHTML = `
                                <svg class="w-5 h-5 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                                </svg>
                                Scan QR Code
                            `;
                            qrCodeScanner = null;
                        });
                    },
                    (errorMessage) => { /* ignore frequent scan errors */ }
                );
                started = true;
                break;
            } catch (err) {
                console.warn('Scanner start attempt failed for config', cfg, err);
                const name = err && err.name ? err.name : '';
                const msg = String(err || '');
                if (name === 'OverconstrainedError' || msg.toLowerCase().includes('overconstrain')) {
                    continue;
                }
                qrReader.classList.add('hidden');
                scanBtn.innerHTML = `
                    <svg class="w-5 h-5 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                    </svg>
                    Scan QR Code
                `;
                qrCodeScanner = null;
                alert('Gagal memulai scanner: ' + (err.message || err));
                return;
            }
        }
    }

    if (!started) {
        qrReader.classList.add('hidden');
        scanBtn.innerHTML = `
            <svg class="w-5 h-5 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
            </svg>
            Scan QR Code
        `;
        qrCodeScanner = null;
        alert('Tidak ada kamera yang cocok atau akses kamera ditolak pada perangkat ini.');
    }
};

// Fetch username function
function fetchUsername(userId) {
    if (!userId) {
        document.getElementById('preview-tujuan').classList.add('hidden');
        return;
    }
    fetch('/api/username/' + encodeURIComponent(userId))
        .then(res => res.json())
        .then(data => {
            const previewDiv = document.getElementById('preview-tujuan');
            const usernameSpan = document.getElementById('tujuan-username');
            const initialSpan = document.getElementById('tujuan-initial');
            const photoImg = document.getElementById('tujuan-photo');
            const borderImg = document.getElementById('tujuan-border');
            if (data.username) {
                usernameSpan.textContent = data.username;
                initialSpan.textContent = data.username.substring(0, 2).toUpperCase();
                previewDiv.classList.remove('hidden');
                if (data.border_url) {
                    borderImg.src = data.border_url;
                    borderImg.style.display = 'block';
                } else {
                    borderImg.style.display = 'none';
                }
                if (data.photo_url) {
                    photoImg.src = data.photo_url;
                    photoImg.style.display = 'block';
                    initialSpan.style.display = 'none';
                } else {
                    photoImg.style.display = 'none';
                    initialSpan.style.display = 'flex';
                }
            } else {
                usernameSpan.textContent = 'Tidak ditemukan';
                initialSpan.textContent = '?';
                photoImg.style.display = 'none';
                borderImg.style.display = 'none';
                initialSpan.style.display = 'flex';
                previewDiv.classList.remove('hidden');
            }
        })
        .catch(() => {
            const previewDiv = document.getElementById('preview-tujuan');
            const usernameSpan = document.getElementById('tujuan-username');
            const initialSpan = document.getElementById('tujuan-initial');
            const photoImg = document.getElementById('tujuan-photo');
            const borderImg = document.getElementById('tujuan-border');
            usernameSpan.textContent = 'Tidak ditemukan';
            initialSpan.textContent = '?';
            photoImg.style.display = 'none';
            borderImg.style.display = 'none';
            initialSpan.style.display = 'flex';
            previewDiv.classList.remove('hidden');
        });
}

// Input event listener
document.getElementById('target_id').addEventListener('input', function() {
    fetchUsername(this.value);
});

// Format number input
document.getElementById('amount').addEventListener('input', function() {
    let value = this.value.replace(/\D/g, '');
    if (value) {
        this.value = parseInt(value);
    }
});

// Modal functionality
const modal = document.getElementById('confirmation-modal');
const pinModal = document.getElementById('pin-modal');
const submitBtn = document.getElementById('submit-btn');
const cancelBtn = document.getElementById('cancel-btn');
const confirmBtn = document.getElementById('confirm-btn');
const pinSubmitBtn = document.getElementById('pin-submit-btn');
const pinInput = document.getElementById('input-pin');
const pinWarning = document.getElementById('pin-warning');
const form = document.getElementById('transfer-form');
const sidebar = document.querySelector('aside');
const bottomNav = document.getElementById('bottom-nav');
const amountInput = document.getElementById('amount');
const balanceInput = document.getElementById('user-balance');
const warningDiv = document.getElementById('amount-warning');

submitBtn.addEventListener('click', function() {
    const targetId = document.getElementById('target_id').value;
    const currentUserId = document.getElementById('current-user-id').value;
    const amount = parseInt(amountInput.value) || 0;
    const username = document.getElementById('tujuan-username').textContent;
    const saldo = balanceInput ? parseInt(balanceInput.value) : 0;

    if (!targetId || !amount || username === 'Tidak ditemukan' || username === '-') {
        alert('Mohon isi semua field dengan benar dan pastikan ID tujuan valid!');
        return;
    }
    if (targetId === currentUserId) {
        warningDiv.textContent = 'Tidak bisa transfer ke akun sendiri!';
        warningDiv.style.display = 'block';
        return;
    }
    if (amount < 5000) {
        warningDiv.textContent = 'Minimal transfer Rp 5.000';
        warningDiv.style.display = 'block';
        return;
    }
    if (amount > saldo) {
        warningDiv.textContent = 'Nominal melebihi saldo Anda!';
        warningDiv.style.display = 'block';
        return;
    }

    scrollPosition = window.scrollY || window.pageYOffset;
    document.body.style.position = 'fixed';
    document.body.style.top = `-${scrollPosition}px`;
    document.body.style.width = '100%';
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';

    if (sidebar) {
        sidebar.classList.add('blur-md');
        sidebar.style.pointerEvents = 'none';
    }

    if (bottomNav) {
        bottomNav.classList.add('blur-md');
        bottomNav.style.pointerEvents = 'none';
        bottomNav.style.zIndex = '50';
    }

    document.getElementById('modal-username').textContent = username;
    document.getElementById('modal-target-id').textContent = targetId;
    document.getElementById('modal-amount').textContent = 'Rp ' + amount.toLocaleString('id-ID');

    modal.classList.remove('hidden');
});

cancelBtn.addEventListener('click', function() {
    modal.classList.add('hidden');
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.width = '';
    document.body.style.overflow = '';
    document.documentElement.style.overflow = '';

    if (sidebar) {
        sidebar.classList.remove('blur-md');
        sidebar.style.pointerEvents = '';
    }

    if (bottomNav) {
        bottomNav.classList.remove('blur-md');
        bottomNav.style.pointerEvents = '';
        bottomNav.style.zIndex = '100';
    }

    window.scrollTo(0, scrollPosition);
});

modal.addEventListener('click', function(e) {
    if (e.target === modal) {
        modal.classList.add('hidden');
        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.width = '';
        document.body.style.overflow = '';
        document.documentElement.style.overflow = '';

        if (sidebar) {
            sidebar.classList.remove('blur-md');
            sidebar.style.pointerEvents = '';
        }

        if (bottomNav) {
            bottomNav.classList.remove('blur-md');
            bottomNav.style.pointerEvents = '';
            bottomNav.style.zIndex = '100';
        }

        window.scrollTo(0, scrollPosition);
    }
});

amountInput.addEventListener('input', function() {
    let value = parseInt(this.value.replace(/\D/g, '')) || 0;
    this.value = value;
    warningDiv.style.display = 'none';

    if (value < 5000 && value !== 0) {
        warningDiv.textContent = 'Minimal transfer Rp 5.000';
        warningDiv.style.display = 'block';
    } else if (balanceInput && value > parseInt(balanceInput.value)) {
        warningDiv.textContent = 'Nominal melebihi saldo Anda!';
        warningDiv.style.display = 'block';
    }
});

confirmBtn.addEventListener('click', function() {
    modal.classList.add('hidden');
    pinModal.classList.remove('hidden');
    pinInput.value = '';
    pinWarning.style.display = 'none';
    pinInput.focus();
});

pinSubmitBtn.addEventListener('click', function() {
    const pin = pinInput.value;
    if (!pin || pin.length !== 6 || !/^\d{6}$/.test(pin)) {
        pinWarning.textContent = 'PIN harus 6 digit angka!';
        pinWarning.style.display = 'block';
        return;
    }
    fetch('/api/cek_pin', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        },
        body: JSON.stringify({ pin: pin })
    })
    .then(res => res.json())
    .then(data => {
        if (data.valid) {
            pinModal.classList.add('hidden');
            form.submit();
        } else {
            pinWarning.textContent = 'PIN salah!';
            pinWarning.style.display = 'block';
        }
    })
    .catch(() => {
        pinWarning.textContent = 'Gagal cek PIN!';
        pinWarning.style.display = 'block';
    });
});

// Add custom styles
const style = document.createElement('style');
style.textContent = `
    @keyframes fade-in {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes bounce-in {
        0% { transform: scale(0.9); opacity: 0; }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); opacity: 1; }
    }
    
    .animate-fade-in {
        animation: fade-in 0.3s ease-out;
    }
    
    .animate-bounce-in {
        animation: bounce-in 0.3s ease-out;
    }
    
    .blur-md {
        filter: blur(5px) !important;
        -webkit-filter: blur(5px) !important;
        transition: filter 0.3s ease !important;
    }
`;
document.head.appendChild(style);

const styleModal = document.createElement('style');
styleModal.textContent = `
    #confirmation-modal, #pin-modal {
        position: fixed !important;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.5);
        z-index: 10000 !important;
        display: none;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    #confirmation-modal:not(.hidden), #pin-modal:not(.hidden) {
        display: flex;
    }
    #confirmation-modal > div, #pin-modal > div {
        position: relative;
        z-index: 10001;
        max-height: 90vh;
        overflow-y: auto;
    }
    @media (max-width: 640px) {
        #confirmation-modal > div, #pin-modal > div {
            max-width: 90vw;
        }
    }
`;
document.head.appendChild(styleModal);
</script>
{% endblock %}