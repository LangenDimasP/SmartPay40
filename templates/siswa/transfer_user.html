{% extends 'base_siswa.html' %}
{% block content %}
<div class="min-h-screen bg-gradient-to-br from-purple-50 to-indigo-100 py-8 px-4">
    <div class="max-w-lg mx-auto">
        <!-- Header Section -->
        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-gradient-to-br from-[#7c4dff] to-[#5e35b1] rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                </svg>
            </div>
            <h2 class="text-3xl font-bold bg-gradient-to-r from-[#7c4dff] to-[#5e35b1] bg-clip-text text-transparent mb-2">
                Transfer Saldo
            </h2>
            <p class="text-gray-600">Kirim saldo ke pengguna lain dengan mudah</p>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="mb-6 space-y-3">
              {% for category, message in messages %}
                <div class="flex items-center p-4 rounded-lg border-l-4 {% if category == 'success' %}bg-green-50 border-green-400 text-green-700{% else %}bg-red-50 border-red-400 text-red-700{% endif %} animate-fade-in">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        {% if category == 'success' %}
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        {% else %}
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                        {% endif %}
                    </svg>
                    <p class="font-medium">{{ message }}</p>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <!-- Main Form Card -->
        <div class="bg-white rounded-2xl shadow-xl border border-purple-100 overflow-hidden">
            <!-- Form Header -->
            <div class="bg-[#7c4dff] px-6 py-4">
                <h3 class="text-xl font-semibold text-white flex items-center">
                    <svg class="w-8 h-8 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                    </svg>
                    Form Transfer
                </h3>
            </div>

            <!-- Form Content -->
            <div class="p-6">
                <input type="hidden" id="current-user-id" value="{{ current_user.id }}">
                <input type="hidden" id="user-balance" value="{{ saldo_user }}">
                <form method="POST" id="transfer-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <!-- ID Tujuan Section -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-[#7c4dff]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            ID Tujuan
                        </label>
                        <div class="relative">
                            <input type="text" name="target_id" id="target_id" required 
                                   class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#7c4dff] focus:border-transparent transition-all duration-200 font-mono text-lg"
                                   placeholder="Masukkan ID tujuan atau scan QR">
                            <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Preview Tujuan -->
                        <div id="preview-tujuan" class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden animate-fade-in">
                            <div class="flex items-center">
                                <div class="relative w-12 h-12 mr-3 flex items-center justify-center" id="tujuan-photo-wrapper">
                                    <!-- Foto profil -->
                                    <img id="tujuan-photo" src="" alt="Foto Profil" class="absolute w-10 h-10 object-cover rounded-full z-10" style="display:none; left:6px; top:6px;">
                                    <!-- Inisial jika tidak ada foto -->
                                    <span id="tujuan-initial" class="absolute w-10 h-10 font-semibold text-white text-sm bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center z-10" style="left:6px; top:6px;"></span>
                                    <!-- Border aktif (z-20 agar di atas foto) -->
                                    <img id="tujuan-border" src="" alt="Border" class="absolute w-full h-full object-cover rounded-full z-20" style="display:none; left:0; top:0;">
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-blue-800">Tujuan Transfer:</p>
                                    <p class="text-lg font-bold text-blue-900" id="tujuan-username">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- QR Scanner Button -->
                        <button type="button" id="scan-btn" 
                                class="mt-3 w-full bg-emerald-600 text-white px-4 py-3 rounded-lg hover:from-emerald-600 hover:to-emerald-700 transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 shadow-lg flex items-center justify-center font-semibold">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                            </svg>
                            Scan QR Code
                        </button>
                        
                        <!-- QR Reader Container -->
                        <div id="qr-reader" class="mt-3 hidden rounded-lg overflow-hidden shadow-lg"></div>
                    </div>

                    <!-- Jumlah Transfer Section -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-[#7c4dff]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                            Jumlah Transfer
                        </label>
                        <div class="relative">
                            <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-semibold">
                                Rp
                            </div>
                            <input type="number" name="amount" id="amount" min="100" required 
                                   class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#7c4dff] focus:border-transparent transition-all duration-200 text-lg"
                                   placeholder="0">
                        </div>
                        <div id="amount-warning" class="text-red-600 text-sm mt-2" style="display:none;"></div>
                        <p class="text-sm text-gray-600 mt-2 flex items-center">
                            <svg class="w-4 h-4 mr-1 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            Minimal transfer Rp 5.000
                        </p>
                    </div>

                    <!-- Submit Button -->
                    <button type="button" id="submit-btn"
                            class="w-full bg-[#7c4dff] text-white py-3 px-6 rounded-lg hover:from-[#5e35b1] hover:to-[#4527a0] transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-[#7c4dff] focus:ring-offset-2 shadow-lg flex items-center justify-center font-semibold text-lg">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                        Kirim Transfer
                    </button>
                </form>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmation-modal" class="fixed left-0 top-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center p-4 z-[10000] hidden">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full animate-bounce-in">
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-[#7c4dff] to-[#5e35b1] px-6 py-4 rounded-t-2xl">
                    <h3 class="text-xl font-semibold text-white flex items-center">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        Konfirmasi Transfer
                    </h3>
                </div>
                
                <!-- Modal Body -->
                <div class="p-6">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <p class="text-lg font-semibold text-gray-800 mb-2">Yakin ingin melakukan transfer?</p>
                        <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Kepada:</span>
                                <span class="font-semibold text-gray-800" id="modal-username">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">ID Tujuan:</span>
                                <span class="font-semibold text-gray-800 font-mono" id="modal-target-id">-</span>
                            </div>
                            <div class="flex justify-between border-t pt-2">
                                <span class="text-gray-600">Jumlah:</span>
                                <span class="font-bold text-xl text-[#7c4dff]" id="modal-amount">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modal Actions -->
                    <div class="flex space-x-3">
                        <button type="button" id="cancel-btn" 
                                class="flex-1 bg-gray-500 text-white py-3 px-4 rounded-lg hover:bg-gray-600 transition-all duration-200 font-semibold flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Batal
                        </button>
                        <button type="button" id="confirm-btn" 
                                class="flex-1 bg-gradient-to-r from-[#7c4dff] to-[#5e35b1] text-white py-3 px-4 rounded-lg hover:from-[#5e35b1] hover:to-[#4527a0] transition-all duration-200 font-semibold flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Ya, Transfer
                        </button>
                    </div>
                </div>
            </div>
        </div>
                <!-- Tambahkan modal PIN di bawah modal konfirmasi -->
        <div id="pin-modal" class="fixed left-0 top-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center p-4 z-[10001] hidden">
            <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center">
                <h3 class="text-lg font-bold mb-2 text-purple-700">Masukkan PIN Transfer</h3>
                <input type="password" id="input-pin" maxlength="6" pattern="\d{6}" class="w-full p-3 border rounded-lg text-lg text-center tracking-widest mb-4" placeholder="••••••" required>
                <div id="pin-warning" class="text-red-600 text-sm mb-2" style="display:none;"></div>
                <button type="button" id="pin-submit-btn" class="w-full bg-purple-600 text-white py-2 rounded-lg font-semibold hover:bg-purple-700 transition">Lanjutkan Transfer</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
let qrCodeScanner = null;
let scrollPosition = 0;

// safer QR Code Scanner: prefer deviceId from getCameras(), fall back to allowed constraints
document.getElementById('scan-btn').onclick = async function() {
    const qrReader = document.getElementById('qr-reader');
    const scanBtn = document.getElementById('scan-btn');

    // If scanner active -> stop it (safe)
    if (qrCodeScanner) {
        try {
            await qrCodeScanner.stop();
        } catch (stopErr) {
            console.warn('qrCodeScanner.stop() error (ignored):', stopErr);
            try { await qrCodeScanner.clear(); } catch(e){ /* ignore */ }
        } finally {
            qrReader.classList.add('hidden');
            scanBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                </svg>
                Scan QR Code
            `;
            qrCodeScanner = null;
        }
        return;
    }

    // show UI
    qrReader.classList.remove('hidden');
    scanBtn.innerHTML = `
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
        Berhenti Scan
    `;

    qrCodeScanner = new Html5Qrcode("qr-reader");

    const startOptions = { fps: 10, qrbox: { width: 200, height: 200 } };

    // Try to enumerate cameras first (preferred, stable)
    let started = false;
    try {
        const cams = await Html5Qrcode.getCameras();
        if (cams && cams.length) {
            // prefer back/rear/environment if label exists, otherwise first camera
            const preferred = cams.find(c => /back|rear|environment/i.test(c.label)) || cams[0];
            try {
                await qrCodeScanner.start(preferred.id, startOptions,
                    (decodedText) => {
                        document.getElementById('target_id').value = decodedText;
                        fetchUsername(decodedText);
                        // safe stop after decode
                        qrCodeScanner.stop().catch(err => {
                            console.warn('stop() after decode error (ignored):', err);
                            try { qrCodeScanner.clear(); } catch(e){/*ignore*/ }
                        }).finally(() => {
                            qrReader.classList.add('hidden');
                            scanBtn.innerHTML = 'Scan QR Code';
                            qrCodeScanner = null;
                        });
                    },
                    (errorMessage) => { /* ignore frequent scan errors */ }
                );
                started = true;
            } catch (err) {
                console.warn('Failed to start with deviceId, will try fallbacks', err);
            }
        }
    } catch (err) {
        console.warn('getCameras() failed or not supported, will try fallbacks', err);
    }

    // If not started, try safer fallbacks that html5-qrcode accepts:
    // library expects either a deviceId string or a string like "environment" (not object with ideal).
    if (!started) {
        const fallbacks = [
            "environment",
            { facingMode: { exact: "environment" } }, // may fail on some devices -> caught below
            "user"
        ];

        for (const cfg of fallbacks) {
            try {
                await qrCodeScanner.start(
                    cfg,
                    startOptions,
                    (decodedText) => {
                        document.getElementById('target_id').value = decodedText;
                        fetchUsername(decodedText);
                        qrCodeScanner.stop().catch(err => {
                            console.warn('stop() after decode error (ignored):', err);
                            try { qrCodeScanner.clear(); } catch(e){/*ignore*/ }
                        }).finally(() => {
                            qrReader.classList.add('hidden');
                            scanBtn.innerHTML = 'Scan QR Code';
                            qrCodeScanner = null;
                        });
                    },
                    (errorMessage) => { /* ignore frequent scan errors */ }
                );
                started = true;
                break;
            } catch (err) {
                console.warn('Scanner start attempt failed for config', cfg, err);
                const name = err && err.name ? err.name : '';
                const msg = String(err || '');
                // If Overconstrained, continue to next fallback
                if (name === 'OverconstrainedError' || msg.toLowerCase().includes('overconstrain')) {
                    continue;
                }
                // other unrecoverable error -> show and stop
                qrReader.classList.add('hidden');
                scanBtn.innerHTML = 'Scan QR Code';
                qrCodeScanner = null;
                alert('Gagal memulai scanner: ' + (err.message || err));
                return;
            }
        }
    }

    if (!started) {
        qrReader.classList.add('hidden');
        scanBtn.innerHTML = 'Scan QR Code';
        qrCodeScanner = null;
        alert('Tidak ada kamera yang cocok atau akses kamera ditolak pada perangkat ini.');
    }
};

// Fetch username function
function fetchUsername(userId) {
    if (!userId) {
        document.getElementById('preview-tujuan').classList.add('hidden');
        return;
    }
    fetch('/api/username/' + encodeURIComponent(userId))
        .then(res => res.json())
        .then(data => {
            const previewDiv = document.getElementById('preview-tujuan');
            const usernameSpan = document.getElementById('tujuan-username');
            const initialSpan = document.getElementById('tujuan-initial');
            const photoImg = document.getElementById('tujuan-photo');
            const borderImg = document.getElementById('tujuan-border');
            if (data.username) {
                usernameSpan.textContent = data.username;
                initialSpan.textContent = data.username.substring(0, 2).toUpperCase();
                previewDiv.classList.remove('hidden');
                if (data.border_url) {
                    borderImg.src = data.border_url;
                    borderImg.style.display = 'block';
                } else {
                    borderImg.style.display = 'none';
                }
                if (data.photo_url) {
                    photoImg.src = data.photo_url;
                    photoImg.style.display = 'block';
                    initialSpan.style.display = 'none';
                } else {
                    photoImg.style.display = 'none';
                    initialSpan.style.display = 'flex';
                }
            } else {
                usernameSpan.textContent = 'Tidak ditemukan';
                initialSpan.textContent = '?';
                photoImg.style.display = 'none';
                borderImg.style.display = 'none';
                initialSpan.style.display = 'flex';
                previewDiv.classList.remove('hidden');
            }
        })
        .catch(() => {
            const previewDiv = document.getElementById('preview-tujuan');
            const usernameSpan = document.getElementById('tujuan-username');
            const initialSpan = document.getElementById('tujuan-initial');
            const photoImg = document.getElementById('tujuan-photo');
            const borderImg = document.getElementById('tujuan-border');
            usernameSpan.textContent = 'Tidak ditemukan';
            initialSpan.textContent = '?';
            photoImg.style.display = 'none';
            borderImg.style.display = 'none';
            initialSpan.style.display = 'flex';
            previewDiv.classList.remove('hidden');
        });
}

// Input event listener
document.getElementById('target_id').addEventListener('input', function() {
    fetchUsername(this.value);
});

// Format number input
document.getElementById('amount').addEventListener('input', function() {
    let value = this.value.replace(/\D/g, '');
    if (value) {
        this.value = parseInt(value);
    }
});

// Modal functionality
const modal = document.getElementById('confirmation-modal');
const submitBtn = document.getElementById('submit-btn');
const cancelBtn = document.getElementById('cancel-btn');
const confirmBtn = document.getElementById('confirm-btn');
const form = document.getElementById('transfer-form');
const sidebar = document.querySelector('aside');
// Perbaikan selector untuk bottom navbar - menggunakan ID yang benar
const bottomNav = document.getElementById('bottom-nav');

submitBtn.addEventListener('click', function() {
    const targetId = document.getElementById('target_id').value;
    const currentUserId = document.getElementById('current-user-id').value;
    const amount = parseInt(amountInput.value) || 0;
    const username = document.getElementById('tujuan-username').textContent;
    const saldo = balanceInput ? parseInt(balanceInput.value) : 0;

    if (!targetId || !amount || username === 'Tidak ditemukan' || username === '-') {
        alert('Mohon isi semua field dengan benar dan pastikan ID tujuan valid!');
        return;
    }
    if (targetId === currentUserId) {
        warningDiv.textContent = 'Tidak bisa transfer ke akun sendiri!';
        warningDiv.style.display = 'block';
        return;
    }
    if (amount < 5000) {
        warningDiv.textContent = 'Minimal transfer Rp 5.000';
        warningDiv.style.display = 'block';
        return;
    }
    if (amount > saldo) {
        warningDiv.textContent = 'Nominal melebihi saldo Anda!';
        warningDiv.style.display = 'block';
        return;
    }

    // Save scroll position and lock body
    scrollPosition = window.scrollY || window.pageYOffset;
    document.body.style.position = 'fixed';
    document.body.style.top = `-${scrollPosition}px`;
    document.body.style.width = '100%';
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';

    // Apply blur to sidebar
    if (sidebar) {
        sidebar.classList.add('blur-md');
        sidebar.style.pointerEvents = 'none';
    }

    // Apply blur to bottom navbar - perbaikan di sini
    if (bottomNav) {
        bottomNav.classList.add('blur-md');
        bottomNav.style.pointerEvents = 'none';
        bottomNav.style.zIndex = '50'; // Turunkan z-index sementara
    }

    // Populate modal
    document.getElementById('modal-username').textContent = username;
    document.getElementById('modal-target-id').textContent = targetId;
    document.getElementById('modal-amount').textContent = 'Rp ' + amount.toLocaleString('id-ID');

    // Show modal
    modal.classList.remove('hidden');
});

cancelBtn.addEventListener('click', function() {
    // Restore scroll position and unlock body
    modal.classList.add('hidden');
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.width = '';
    document.body.style.overflow = '';
    document.documentElement.style.overflow = '';
    
    // Remove blur and restore pointer events for sidebar
    if (sidebar) {
        sidebar.classList.remove('blur-md');
        sidebar.style.pointerEvents = '';
    }
    
    // Remove blur and restore pointer events for bottom navbar
    if (bottomNav) {
        bottomNav.classList.remove('blur-md');
        bottomNav.style.pointerEvents = '';
        bottomNav.style.zIndex = '100'; // Kembalikan z-index
    }
    
    window.scrollTo(0, scrollPosition);
});

modal.addEventListener('click', function(e) {
    if (e.target === modal) {
        // Restore scroll position and unlock body
        modal.classList.add('hidden');
        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.width = '';
        document.body.style.overflow = '';
        document.documentElement.style.overflow = '';
        
        // Remove blur and restore pointer events for sidebar
        if (sidebar) {
            sidebar.classList.remove('blur-md');
            sidebar.style.pointerEvents = '';
        }
        
        // Remove blur and restore pointer events for bottom navbar
        if (bottomNav) {
            bottomNav.classList.remove('blur-md');
            bottomNav.style.pointerEvents = '';
            bottomNav.style.zIndex = '100'; // Kembalikan z-index
        }
        
        window.scrollTo(0, scrollPosition);
    }
});

const amountInput = document.getElementById('amount');
const balanceInput = document.getElementById('user-balance');
const warningDiv = document.getElementById('amount-warning');
amountInput.addEventListener('input', function() {
    let value = parseInt(this.value.replace(/\D/g, '')) || 0;
    this.value = value;
    warningDiv.style.display = 'none';

    if (value < 5000 && value !== 0) {
        warningDiv.textContent = 'Minimal transfer Rp 5.000';
        warningDiv.style.display = 'block';
    } else if (balanceInput && value > parseInt(balanceInput.value)) {
        warningDiv.textContent = 'Nominal melebihi saldo Anda!';
        warningDiv.style.display = 'block';
    }
});

const pinModal = document.getElementById('pin-modal');
const pinInput = document.getElementById('input-pin');
const pinWarning = document.getElementById('pin-warning');
const pinSubmitBtn = document.getElementById('pin-submit-btn');

// Pada confirmBtn event, ganti form.submit() dengan buka modal PIN
confirmBtn.addEventListener('click', function() {
    modal.classList.add('hidden');
    pinModal.classList.remove('hidden');
    pinInput.value = '';
    pinWarning.style.display = 'none';
    pinInput.focus();
});

// Validasi PIN ke server sebelum submit transfer
pinSubmitBtn.addEventListener('click', function() {
    const pin = pinInput.value;
    if (!pin || pin.length !== 6 || !/^\d{6}$/.test(pin)) {
        pinWarning.textContent = 'PIN harus 6 digit angka!';
        pinWarning.style.display = 'block';
        return;
    }
    // Kirim AJAX ke server untuk validasi PIN
    fetch('/api/cek_pin', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        },
        body: JSON.stringify({ pin: pin })
    })
    .then(res => res.json())
    .then(data => {
        if (data.valid) {
            pinModal.classList.add('hidden');
            form.submit();
        } else {
            pinWarning.textContent = 'PIN salah!';
            pinWarning.style.display = 'block';
        }
    })
    .catch(() => {
        pinWarning.textContent = 'Gagal cek PIN!';
        pinWarning.style.display = 'block';
    });
});

// Add custom styles
const style = document.createElement('style');
style.textContent = `
    @keyframes fade-in {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes bounce-in {
        0% { transform: scale(0.9); opacity: 0; }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); opacity: 1; }
    }
    
    .animate-fade-in {
        animation: fade-in 0.3s ease-out;
    }
    
    .animate-bounce-in {
        animation: bounce-in 0.3s ease-out;
    }
    
    .blur-md {
        filter: blur(5px) !important;
        -webkit-filter: blur(5px) !important; /* Support for Safari */
        transition: filter 0.3s ease !important;
    }
`;
document.head.appendChild(style);

const styleModal = document.createElement('style');
styleModal.textContent = `
    #confirmation-modal {
        position: fixed !important;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.5);
        z-index: 10000 !important;
        display: none;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    #confirmation-modal:not(.hidden) {
        display: flex;
    }
    #confirmation-modal > div {
        position: relative;
        z-index: 10001;
        max-height: 90vh;
        overflow-y: auto;
    }
    @media (max-width: 640px) {
        #confirmation-modal > div {
            max-width: 90vw;
        }
    }
`;
document.head.appendChild(styleModal);
</script>
{% endblock %}