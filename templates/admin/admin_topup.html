{% extends 'admin_base.html' %}

{% block title %}Admin - Top Up Saldo{% endblock %}

{% block styles %}
{{ super() }}
{% endblock %}

{% block admin_content %}
<div class="max-w-xl mx-auto bg-[#f9f5ff] p-6 rounded-xl shadow-lg mt-5">
    <h2 class="text-[#7c4dff] font-semibold text-2xl mb-4 relative pb-2 after:content-[''] after:absolute after:bottom-0 after:left-0 after:w-12 after:h-0.5 after:bg-gradient-to-r after:from-[#7c4dff] after:to-[#5e35b1] after:rounded">
        Top Up Saldo Siswa
    </h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="my-4">
        {% for category, message in messages %}
        <p class="p-3 rounded {{ 'bg-green-50 border-l-4 border-green-600 text-green-600' if category == 'success' else 'bg-red-50 border-l-4 border-red-600 text-red-600' }}">
            {{ message }}
        </p>
        {% endfor %}
    </div>
    <hr class="my-5 border-0 h-px bg-gradient-to-r from-[rgba(124,77,255,0.1)] via-[rgba(124,77,255,0.3)] to-[rgba(124,77,255,0.1)]" />
    {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('admin_topup') }}" class="bg-white p-5 rounded-lg shadow-md border border-[rgba(124,77,255,0.1)]">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-5">
    <label for="user_id" class="block text-sm font-medium text-[#5e35b1] mb-2">ID Siswa:</label>
    <div class="flex gap-2">
        <input
            type="text"
            id="user_id"
            name="user_id"
            maxlength="10"
            required
            placeholder="Masukkan ID Siswa atau scan barcode"
            class="w-full p-3 border border-[rgba(124,77,255,0.3)] rounded-lg text-[#333333] bg-white focus:ring-2 focus:ring-[#7c4dff] focus:border-[#7c4dff]"
        />
        <button type="button" id="scan-btn" class="bg-[#7c4dff] text-white px-3 py-2 rounded-lg font-medium hover:bg-[#5e35b1] transition flex items-center gap-1">
            <i class="fas fa-qrcode"></i> Scan
        </button>
    </div>
    <div id="student-username" class="mt-2 text-sm text-[#5e35b1] font-semibold"></div>
    <div id="qr-reader" class="mt-3 hidden rounded-lg overflow-hidden shadow-lg"></div>
</div>
        <div class="mb-5">
            <label for="amount" class="block text-sm font-medium text-[#5e35b1] mb-2">Jumlah Top Up (Rp):</label>
            <input
                type="number"
                id="amount"
                name="amount"
                min="100"
                step="any"
                required
                placeholder="Minimal 100"
                class="w-full p-3 border border-[rgba(124,77,255,0.3)] rounded-lg text-[#333333] bg-white focus:ring-2 focus:ring-[#7c4dff] focus:border-[#7c4dff]"
            />
        </div>
        <button type="submit"
            class="w-full p-3 bg-gradient-to-r from-[#7c4dff] to-[#5e35b1] text-white rounded-lg font-semibold hover:from-[#5e35b1] hover:to-[#7c4dff] hover:-translate-y-0.5 hover:shadow-lg transition-all duration-300 shadow-md">
            Proses Top Up
        </button>
    </form>
    <hr class="my-5 border-0 h-px bg-gradient-to-r from-[rgba(124,77,255,0.1)] via-[rgba(124,77,255,0.3)] to-[rgba(124,77,255,0.1)]" />
    <p>
        <a href="{{ url_for('admin_dashboard_content') }}"
           class="inline-flex items-center gap-2 text-[#7c4dff] font-medium text-sm py-2 px-3 rounded hover:bg-[#f9f5ff] hover:text-[#5e35b1] hover:-translate-x-1 transition-all duration-300">
            <i class="fas fa-arrow-left"></i> Kembali ke Dashboard Admin
        </a>
    </p>
</div>

<!-- Barcode Scanner Script -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
let qrCodeScanner = null;
document.getElementById('scan-btn').onclick = function() {
    const qrReader = document.getElementById('qr-reader');
    const scanBtn = document.getElementById('scan-btn');
    if (qrCodeScanner) {
        qrCodeScanner.stop().then(() => {
            qrReader.classList.add('hidden');
            scanBtn.innerHTML = '<i class="fas fa-qrcode"></i> Scan';
            qrCodeScanner = null;
        });
        return;
    }
    qrReader.classList.remove('hidden');
    scanBtn.innerHTML = '<i class="fas fa-times"></i> Stop';
    qrCodeScanner = new Html5Qrcode("qr-reader");
    qrCodeScanner.start(
        { facingMode: { exact: "environment" } },
        { fps: 10, qrbox: { width: 200, height: 200 } },
        (decodedText, decodedResult) => {
            document.getElementById('user_id').value = decodedText;
            fetchUsername(decodedText);
            qrCodeScanner.stop().then(() => {
                qrReader.classList.add('hidden');
                scanBtn.innerHTML = '<i class="fas fa-qrcode"></i> Scan';
                qrCodeScanner = null;
            });
        },
        (errorMessage) => {
            // ignore scan errors
        }
    ).catch(err => {
        qrReader.classList.add('hidden');
        scanBtn.innerHTML = '<i class="fas fa-qrcode"></i> Scan';
    });
};

// AJAX untuk ambil nama siswa
document.getElementById('user_id').addEventListener('input', function() {
    const id = this.value.trim();
    fetchUsername(id);
});

function fetchUsername(id) {
    const usernameDiv = document.getElementById('student-username');
    if (!id) {
        usernameDiv.textContent = '';
        return;
    }
    fetch(`/admin/get_student_username?id=${encodeURIComponent(id)}`)
        .then(res => res.json())
        .then(data => {
            if (data.username) {
                usernameDiv.textContent = 'Nama: ' + data.username;
                usernameDiv.style.color = '#5e35b1';
            } else {
                usernameDiv.textContent = 'ID tidak ditemukan atau bukan siswa';
                usernameDiv.style.color = '#e53935';
            }
        })
        .catch(() => {
            usernameDiv.textContent = '';
        });
}
</script>
{% endblock admin_content %}