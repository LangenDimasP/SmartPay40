{% extends 'admin_base.html' %}

{% block title %}Admin - Request Top Up Pending{% endblock %}

{% block styles %}
{{ super() }}
{% endblock %}

{% block admin_content %}
<div class="p-5 rounded-xl shadow-lg bg-[#f9f5ff] mt-5">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-[#7c4dff] font-semibold text-2xl relative pb-2 after:content-[''] after:absolute after:bottom-0 after:left-0 after:w-12 after:h-0.5 after:bg-gradient-to-r after:from-[#7c4dff] after:to-[#5e35b1] after:rounded">Request Top Up Pending</h2>
        <a href="{{ url_for('admin_topup') }}" class="flex items-center gap-2 bg-[#7c4dff] text-white px-5 py-2 rounded-lg font-medium hover:bg-[#5e35b1] hover:-translate-y-0.5 hover:shadow-md transition-all shadow">
            <i class="fas fa-plus text-sm"></i> Top Up Manual
        </a>
    </div>
    <p class="text-gray-600 text-base mb-5">Daftar permintaan top up saldo dari siswa yang menunggu persetujuan Anda setelah pembayaran tunai diterima.</p>
    <hr class="border-0 h-px bg-gradient-to-r from-[rgba(124,77,255,0.1)] via-[rgba(124,77,255,0.3)] to-[rgba(124,77,255,0.1)] my-5" />

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mt-4 mb-5">
                {% for category, message in messages %}
                    <p class="{% if category == 'success' %}bg-green-100 border-l-4 border-green-600 text-green-600 p-3 rounded-md text-sm{% else %}bg-red-100 border-l-4 border-red-600 text-red-600 p-3 rounded-md text-sm{% endif %}">{{ message }}</p>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="overflow-x-auto bg-white rounded-lg shadow-md border border-[rgba(124,77,255,0.1)]">
        <table class="min-w-full font-['Poppins',sans-serif]">
            <thead>
                <tr>
                    <th class="py-3.5 px-4.5 bg-gradient-to-r from-[#f9f5ff] to-white font-semibold text-[#5e35b1] text-xs uppercase tracking-wider border-b-2 border-[#7c4dff] text-center sticky top-0 z-10">ID Req.</th>
                    <th class="py-3.5 px-4.5 bg-gradient-to-r from-[#f9f5ff] to-white font-semibold text-[#5e35b1] text-xs uppercase tracking-wider border-b-2 border-[#7c4dff] text-center sticky top-0 z-10">Waktu Request</th>
                    <th class="py-3.5 px-4.5 bg-gradient-to-r from-[#f9f5ff] to-white font-semibold text-[#5e35b1] text-xs uppercase tracking-wider border-b-2 border-[#7c4dff] text-center sticky top-0 z-10">Nama Siswa</th>
                    <th class="py-3.5 px-4.5 bg-gradient-to-r from-[#f9f5ff] to-white font-semibold text-[#5e35b1] text-xs uppercase tracking-wider border-b-2 border-[#7c4dff] text-center sticky top-0 z-10">Kelas/Jur.</th>
                    <th class="py-3.5 px-4.5 bg-gradient-to-r from-[#f9f5ff] to-white font-semibold text-[#5e35b1] text-xs uppercase tracking-wider border-b-2 border-[#7c4dff] text-center sticky top-0 z-10">Jumlah Request</th>
                    <th class="py-3.5 px-4.5 bg-gradient-to-r from-[#f9f5ff] to-white font-semibold text-[#5e35b1] text-xs uppercase tracking-wider border-b-2 border-[#7c4dff] text-center sticky top-0 z-10">Bukti Transfer</th>
                    <th class="py-3.5 px-4.5 bg-gradient-to-r from-[#f9f5ff] to-white font-semibold text-[#5e35b1] text-xs uppercase tracking-wider border-b-2 border-[#7c4dff] text-center sticky top-0 z-10 min-w-[120px]">Aksi</th>
                </tr>
            </thead>
            <tbody>
                {% for req in requests %}
                    <tr class="hover:bg-[rgba(124,77,255,0.05)] transition-colors even:bg-[rgba(249,245,255,0.3)]">
                        <td data-label="ID Req." class="py-3.5 pl-3 px-4.5 border-b border-[rgba(124,77,255,0.1)] text-sm text-[#333333] text-center">{{ req.id }}</td>
                        <td data-label="Waktu Req." class="py-3.5 px-4.5 border-b border-[rgba(124,77,255,0.1)] text-sm text-[#333333] text-center">
                            <span class="text-gray-500 text-sm">{{ req.request_timestamp | wib }}</span>
                        </td>
                        <td data-label="Siswa" class="py-3.5 pl-3 px-4.5 border-b border-[rgba(124,77,255,0.1)] text-sm text-[#333333] text-center">{{ req.student.username if req.student else 'N/A' }}</td>
                        <td data-label="Kelas/Jur." class="py-3.5 px-4.5 border-b border-[rgba(124,77,255,0.1)] text-sm text-[#333333] text-center">
                            {% if req.student and req.student.kelas and req.student.jurusan %}
                                {{ req.student.kelas }} - {{ req.student.jurusan }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td data-label="Jumlah" class="py-3.5 pl-3 px-4.5 border-b border-[rgba(124,77,255,0.1)] text-sm text-left text-green-600 font-semibold">
                            {{ req.amount | short_rupiah }}
                        </td>
                                    <td data-label="Bukti Transfer" class="py-3.5 px-4.5 border-b border-[rgba(124,77,255,0.1)] text-sm text-center align-middle">
                {% if req.bukti_transfer_filename %}
                    <button type="button"
                        class="bg-[#ede7f6] text-[#7c4dff] px-3 py-1 rounded-md text-xs font-medium hover:bg-[#d1c4e9] transition"
                        onclick="showBuktiTransfer('{{ url_for('static', filename='profile_pics/' ~ req.bukti_transfer_filename) }}')">
                        <i class="fas fa-image"></i> Lihat Bukti
                    </button>
                {% else %}
                    <span class="text-gray-400 italic">-</span>
                {% endif %}
            </td>
                        <td data-label="Aksi" class="py-3.5 px-4.5 border-b border-[rgba(124,77,255,0.1)] text-sm text-center align-middle">
                            <div class="flex justify-center items-center gap-2">
                                <form method="POST" action="{{ url_for('admin_approve_topup', request_id=req.id) }}" class="inline" onsubmit="return confirm('Konfirmasi persetujuan top up sebesar {{ req.amount|rupiah }} untuk {{ req.student.username if req.student else 'siswa ini' }}? Pastikan uang tunai sudah diterima.')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                    <button type="submit" class="bg-gradient-to-r from-green-600 to-green-800 text-white px-3.5 py-2 rounded-md text-sm font-medium flex items-center gap-1.5 hover:from-green-700 hover:to-green-600 hover:-translate-y-0.5 hover:shadow-md transition-all shadow" title="Setujui Request">
                                        <i class="fas fa-check text-sm"></i> Approve
                                    </button>
                                </form>
                                {% if req.bukti_transfer_filename %}
                                    <button type="button" class="bg-[#7c4dff] text-white px-3.5 py-2 rounded-md text-sm font-medium flex items-center gap-1.5 hover:bg-[#5e35b1] hover:-translate-y-0.5 hover:shadow-md transition-all shadow" onclick="showBuktiTransfer('{{ url_for('static', filename='profile_pics/' ~ req.bukti_transfer_filename) }}')">
                                        <i class="fas fa-image text-sm"></i> Lihat Bukti
                                    </button>
                                {% endif %}
                                {# Uncomment if you want to enable the Reject button #}
                                {#
                                <form method="POST" action="{{ url_for('admin_reject_topup', request_id=req.id) }}" class="inline" onsubmit="return confirm('Yakin menolak request ini?')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                    <button type="submit" class="bg-gradient-to-r from-red-600 to-red-800 text-white px-3.5 py-2 rounded-md text-sm font-medium flex items-center gap-1.5 hover:from-red-700 hover:to-red-600 hover:-translate-y-0.5 hover:shadow-md transition-all shadow" title="Tolak Request">
                                        <i class="fas fa-times text-sm"></i> Reject
                                    </button>
                                </form>
                                #}
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                {% if not requests %}
                    <tr>
                        <td colspan="6" class="text-center py-10 text-gray-500 italic bg-gradient-to-r from-white to-[#f9f5ff] rounded-lg text-lg">Tidak ada request top up yang menunggu persetujuan saat ini.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    <hr class="border-0 h-px bg-gradient-to-r from-[rgba(124,77,255,0.1)] via-[rgba(124,77,255,0.3)] to-[rgba(124,77,255,0.1)] my-5" />
</div>

<!-- Modal Pop-up Bukti Transfer -->
<div id="buktiTransferModal" class="hidden fixed inset-0 z-[9999] bg-[rgba(0,0,0,0.6)] flex justify-center items-center">
    <div class="bg-white p-4 rounded-xl shadow-lg max-w-[90vw] max-h-[90vh] relative">
        <button onclick="closeBuktiTransfer()" class="absolute top-3 right-3 bg-[#7c4dff] text-white rounded-full w-8 h-8 text-lg cursor-pointer flex items-center justify-center hover:bg-[#5e35b1] transition-colors">&times;</button>
        <img id="buktiTransferImg" src="" alt="Bukti Transfer" class="max-w-[80vw] max-h-[70vh] rounded-lg block mx-auto">
    </div>
</div>

<script>
function showBuktiTransfer(imgUrl) {
    document.getElementById('buktiTransferImg').src = imgUrl;
    document.getElementById('buktiTransferModal').style.display = 'flex';
}
function closeBuktiTransfer() {
    document.getElementById('buktiTransferModal').style.display = 'none';
    document.getElementById('buktiTransferImg').src = '';
}
</script>
{% endblock admin_content %}