{% extends 'admin_base.html' %} 
{% block title %}Admin - Daftar Pengguna{% endblock %} 

{% block admin_content %}
<div class="p-5 font-['Poppins']">
    <!-- Header -->
    <h2 class="text-[#7c4dff] mb-8 font-semibold text-3xl relative pb-3 inline-block tracking-wide">
        Daftar Semua Pengguna Terdaftar
    </h2>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %} 
    {% if messages %}
    <div class="mb-6">
        {% for category, message in messages %}
            {% if category == 'success' %}
            <p class="bg-green-50 border-l-4 border-green-500 p-4 rounded-lg shadow-sm mb-3 text-green-800">
                {{ message }}
            </p>
            {% elif category == 'danger' %}
            <p class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg shadow-sm mb-3 text-red-800">
                {{ message }}
            </p>
            {% endif %}
        {% endfor %}
    </div>
    {% endif %} 
    {% endwith %}

        <!-- Data Table Container -->
    <div class="rounded-xl overflow-x-auto my-8">
        <form method="GET" action="{{ url_for('admin_export_users') }}" class="mb-8 flex flex-wrap gap-4 items-end">
    <div>
        <label for="export_role" class="block font-medium text-sm text-gray-600 mb-1">Jenis User:</label>
        <select id="export_role" name="role" class="border border-gray-300 rounded-full px-4 py-2 text-sm text-gray-800 bg-white shadow-md">
            <option value="">Semua</option>
            <option value="siswa">Siswa</option>
            <option value="penjual">Penjual</option>
        </select>
    </div>
    <div>
        <label for="export_kelas" class="block font-medium text-sm text-gray-600 mb-1">Kelas:</label>
        <select id="export_kelas" name="kelas" class="border border-gray-300 rounded-full px-4 py-2 text-sm text-gray-800 bg-white shadow-md">
            <option value="">Semua</option>
            <option value="X">X</option>
            <option value="XI">XI</option>
            <option value="XII">XII</option>
        </select>
    </div>
    <div>
        <label for="export_jurusan" class="block font-medium text-sm text-gray-600 mb-1">Jurusan:</label>
        <select id="export_jurusan" name="jurusan" class="border border-gray-300 rounded-full px-4 py-2 text-sm text-gray-800 bg-white shadow-md">
            <option value="">Semua</option>
            <option value="RPL">RPL</option>
            <option value="DKV1">DKV1</option>
            <option value="DKV2">DKV2</option>
            <option value="AK">AK</option>
            <option value="MP">MP</option>
            <option value="BR">BR</option>
        </select>
    </div>
    <button type="submit" class="bg-gradient-to-r from-[#7c4dff] to-[#9969ff] text-white border-0 rounded-full px-4 py-2 text-sm cursor-pointer transition-all duration-200 shadow-md shadow-[#7c4dff]/30 hover:from-[#6a3de8] hover:to-[#7c4dff] hover:-translate-y-0.5 hover:shadow-lg hover:shadow-[#7c4dff]/40">
        Export Excel
    </button>
</form>

    <!-- Filter Form -->
    <form method="GET" action="{{ url_for('admin_users') }}" class="mb-5 flex flex-wrap gap-4 items-end">
        <div>
            <label for="kelas" class="block font-medium text-sm text-gray-600 mb-1">Kelas:</label>
            <select id="kelas" name="kelas" class="border border-gray-300 rounded-full px-4 py-2 text-sm text-gray-800 bg-white shadow-md transition-all duration-200 outline-none focus:border-[#7c4dff] focus:shadow-lg focus:shadow-[#7c4dff]/30">
                <option value="" {% if not filter_kelas %}selected{% endif %}>Semua Kelas</option>
                <option value="X" {% if filter_kelas == 'X' %}selected{% endif %}>X</option>
                <option value="XI" {% if filter_kelas == 'XI' %}selected{% endif %}>XI</option>
                <option value="XII" {% if filter_kelas == 'XII' %}selected{% endif %}>XII</option>
            </select>
        </div>
        
        <div>
            <label for="jurusan" class="block font-medium text-sm text-gray-600 mb-1">Jurusan:</label>
            <select id="jurusan" name="jurusan" class="border border-gray-300 rounded-full px-4 py-2 text-sm text-gray-800 bg-white shadow-md transition-all duration-200 outline-none focus:border-[#7c4dff] focus:shadow-lg focus:shadow-[#7c4dff]/30">
                <option value="" {% if not filter_jurusan %}selected{% endif %}>Semua Jurusan</option>
                <option value="RPL" {% if filter_jurusan == 'RPL' %}selected{% endif %}>RPL</option>
                <option value="DKV1" {% if filter_jurusan == 'DKV1' %}selected{% endif %}>DKV1</option>
                <option value="DKV2" {% if filter_jurusan == 'DKV2' %}selected{% endif %}>DKV2</option>
                <option value="AK" {% if filter_jurusan == 'AK' %}selected{% endif %}>AK</option>
                <option value="MP" {% if filter_jurusan == 'MP' %}selected{% endif %}>MP</option>
                <option value="BR" {% if filter_jurusan == 'BR' %}selected{% endif %}>BR</option>
            </select>
        </div>
        
        <div>
            <label for="user_id" class="block font-medium text-sm text-gray-600 mb-1">ID Pengguna:</label>
            <input type="number" id="user_id" name="user_id" value="{{ filter_user_id or '' }}"
                   placeholder="Cari ID..."
                   class="border border-gray-300 rounded-full px-4 py-2 text-sm text-gray-800 bg-white shadow-md transition-all duration-200 outline-none focus:border-[#7c4dff] focus:shadow-lg focus:shadow-[#7c4dff]/30">
        </div>
        
        <div class="flex gap-2">
            <button type="submit" class="bg-gradient-to-r from-[#7c4dff] to-[#9969ff] text-white border-0 rounded-full px-4 py-2 text-sm cursor-pointer transition-all duration-200 shadow-md shadow-[#7c4dff]/30 hover:from-[#6a3de8] hover:to-[#7c4dff] hover:-translate-y-0.5 hover:shadow-lg hover:shadow-[#7c4dff]/40">
                Filter
            </button>
            <a href="{{ url_for('admin_users') }}" class="bg-gradient-to-r from-red-500 to-red-400 text-white border-0 rounded-full px-4 py-2 text-sm no-underline transition-all duration-200 shadow-md shadow-red-500/30 hover:from-red-600 hover:to-red-500 hover:-translate-y-0.5 hover:shadow-lg hover:shadow-red-500/40">
                Reset
            </a>
        </div>
    </form>
        <table class="w-full border-collapse bg-white">
            <!-- Table Header -->
            <thead>
                <tr class="bg-gradient-to-r from-[#7c4dff] to-[#9969ff] text-white uppercase text-sm tracking-wide">
                    <th class="p-4 font-semibold text-left align-middle text-white">ID</th>
                    <th class="p-4 font-semibold text-left align-middle text-white">Username</th>
                    <th class="p-4 font-semibold text-center align-middle text-white">Peran</th>
                    <th class="p-4 font-semibold text-center align-middle text-white">Kelas</th>
                    <th class="p-4 font-semibold text-center align-middle text-white">Jurusan</th>
                    <th class="p-4 font-semibold text-center align-middle text-white">Saldo</th>
                    <th class="p-4 font-semibold text-center align-middle text-white">Status</th>
                    <th class="p-4 font-semibold text-center align-middle text-white">Aksi</th>
                </tr>
            </thead>
            
            <!-- Table Body -->
            <tbody>
                {% for user in users %}
                <tr class="hover:bg-indigo-50 transition-all duration-200">
                    <td class="px-4 py-4 border-b border-indigo-100 text-sm">{{ user.id }}</td>
                    <td class="px-4 py-4 border-b border-indigo-100 text-sm">{{ user.username }}</td>
                    <td class="px-4 py-4 border-b border-indigo-100 text-sm text-center">{{ user.role.capitalize() }}</td>
                    <td class="px-4 py-4 border-b border-indigo-100 text-sm text-center">{{ user.kelas if user.kelas else '-' }}</td>
                    <td class="px-4 py-4 border-b border-indigo-100 text-sm text-center">{{ user.jurusan if user.jurusan else '-' }}</td>
                    <td class="px-4 py-4 border-b border-indigo-100 text-sm text-center">{{ user.balance|rupiah }}</td>
                    <td class="px-4 py-4 border-b border-indigo-100 text-sm text-center">
                        {% if user.is_active %}
                        <span class="text-green-600 font-semibold bg-green-100 px-3 py-1.5 rounded-full inline-block">Aktif</span>
                        {% else %}
                        <span class="text-red-500 font-semibold bg-red-100 px-3 py-1.5 rounded-full inline-block">Nonaktif</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-4 border-b border-indigo-100 text-sm text-center whitespace-nowrap">
                        <form method="POST" action="{{ url_for('toggle_user_active', user_id=user.id) }}" class="inline-block">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            {% if user.is_active %}
                            <button type="submit" class="bg-gradient-to-r from-orange-500 to-orange-400 text-white rounded-full px-4 py-2 mx-0.5 text-sm border-0 cursor-pointer transition-all duration-200 shadow-md font-medium hover:from-orange-600 hover:to-orange-500 hover:-translate-y-0.5 hover:shadow-lg hover:shadow-orange-500/30">
                                Nonaktifkan
                            </button>
                            {% else %}
                            <button type="submit" class="bg-gradient-to-r from-green-600 to-green-400 text-white rounded-full px-4 py-2 mx-0.5 text-sm border-0 cursor-pointer transition-all duration-200 shadow-md font-medium hover:from-green-700 hover:to-green-600 hover:-translate-y-0.5 hover:shadow-lg hover:shadow-green-600/30">
                                Aktifkan
                            </button>
                            {% endif %}
                        </form>
                        <a href="{{ url_for('admin_edit_user', user_id=user.id) }}" class="bg-gradient-to-r from-[#7c4dff] to-[#b388ff] text-white rounded-full px-4 py-2 mx-0.5 text-sm no-underline inline-block transition-all duration-200 shadow-md font-medium hover:from-[#6a3de8] hover:to-[#7c4dff] hover:-translate-y-0.5 hover:shadow-lg hover:shadow-[#7c4dff]/30">
                            Edit
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="text-center py-10 px-5 text-gray-400 italic">Belum ada pengguna terdaftar.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="flex justify-center mt-8">
        <nav aria-label="Page navigation">
            <ul class="flex justify-center list-none p-0 bg-white rounded-full shadow-lg shadow-[#7c4dff]/10 px-1.5 py-1.5">
                {% if pagination.has_prev %}
                <li>
                    <a class="text-[#7c4dff] px-4 py-2.5 no-underline rounded-full block font-medium min-w-10 text-center transition-all duration-200 hover:bg-indigo-50" 
                       href="{{ url_for('admin_users', page=pagination.prev_num) }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% else %}
                <li>
                    <span class="text-gray-300 px-4 py-2.5 rounded-full block font-medium min-w-10 text-center pointer-events-none">&laquo;</span>
                </li>
                {% endif %}

                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}
                    {% if page_num == pagination.page %}
                    <li>
                        <span class="bg-gradient-to-r from-[#7c4dff] to-[#9969ff] text-white px-4 py-2.5 rounded-full block font-medium min-w-10 text-center shadow-md shadow-[#7c4dff]/30">{{ page_num }}</span>
                    </li>
                    {% else %}
                    <li>
                        <a class="text-[#7c4dff] px-4 py-2.5 no-underline rounded-full block font-medium min-w-10 text-center transition-all duration-200 hover:bg-indigo-50" 
                           href="{{ url_for('admin_users', page=page_num) }}">{{ page_num }}</a>
                    </li>
                    {% endif %}
                {% else %}
                <li>
                    <span class="text-gray-300 px-4 py-2.5 rounded-full block font-medium min-w-10 text-center pointer-events-none">…</span>
                </li>
                {% endif %}
                {% endfor %}

                {% if pagination.has_next %}
                <li>
                    <a class="text-[#7c4dff] px-4 py-2.5 no-underline rounded-full block font-medium min-w-10 text-center transition-all duration-200 hover:bg-indigo-50" 
                       href="{{ url_for('admin_users', page=pagination.next_num) }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                {% else %}
                <li>
                    <span class="text-gray-300 px-4 py-2.5 rounded-full block font-medium min-w-10 text-center pointer-events-none">&raquo;</span>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
{% endblock admin_content %}