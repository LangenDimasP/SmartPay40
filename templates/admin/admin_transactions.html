{% extends 'admin_base.html' %}

{% block title %}Admin - Semua Transaksi{% endblock %}

{% block admin_content %}
<div class="max-w-full mx-auto p-5">
    <h2 class="text-[#7c4dff] mb-7 font-semibold text-2xl relative pb-3 inline-block tracking-wider">Riwayat Semua Transaksi Sistem</h2>

    {# Flash messages #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-6">
                {% for category, message in messages %}
                    <p class="{% if category == 'success' %}bg-green-100 border-l-4 border-green-600 p-4 rounded-lg shadow-sm{% else %}bg-red-100 border-l-4 border-red-600 p-4 rounded-lg shadow-sm{% endif %}">{{ message }}</p>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    {# === FORM FILTER TRANSAKSI ADMIN === #}
    <form method="GET" action="{{ url_for('admin_transactions') }}" class="flex flex-wrap gap-4 items-end mb-5">
        <div>
            <label for="start_date" class="block font-medium text-sm text-gray-600 mb-1">Dari Tgl:</label>
            <input type="date" id="start_date" name="start_date" value="{{ filter_start_date }}" class="border border-gray-300 rounded-full px-4 py-2 text-sm text-gray-700 bg-white shadow-sm focus:border-[#7c4dff] focus:ring-2 focus:ring-[#7c4dff]/30 outline-none">
        </div>
        <div>
            <label for="end_date" class="block font-medium text-sm text-gray-600 mb-1">Sampai Tgl:</label>
            <input type="date" id="end_date" name="end_date" value="{{ filter_end_date }}" class="border border-gray-300 rounded-full px-4 py-2 text-sm text-gray-700 bg-white shadow-sm focus:border-[#7c4dff] focus:ring-2 focus:ring-[#7c4dff]/30 outline-none">
        </div>
        <div>
            <label for="filter_type" class="block font-medium text-sm text-gray-600 mb-1">Tipe Transaksi:</label>
            <select id="filter_type" name="filter_type" class="border border-gray-300 rounded-full px-4 py-2 text-sm text-gray-700 bg-white shadow-sm focus:border-[#7c4dff] focus:ring-2 focus:ring-[#7c4dff]/30 outline-none">
                <option value="all" {% if selected_type_filter == 'all' %}selected{% endif %}>Semua Tipe</option>
                <option value="payment" {% if selected_type_filter == 'payment' %}selected{% endif %}>Payment</option>
                <option value="topup" {% if selected_type_filter == 'topup' %}selected{% endif %}>Top Up</option>
                <option value="cashout_vendor" {% if selected_type_filter == 'cashout_vendor' %}selected{% endif %}>Cash Out Vendor</option>
                <option value="transfer" {% if selected_type_filter == 'transfer' %}selected{% endif %}>Transfer</option>
            </select>
        </div>
    <div>
        <label for="transaction_id" class="block font-medium text-sm text-gray-600 mb-1">ID Transaksi:</label>
        <input type="number" id="transaction_id" name="transaction_id" value="{{ filter_transaction_id or '' }}" placeholder="Cari ID..." class="border border-gray-300 rounded-full px-4 py-2 text-sm text-gray-700 bg-white shadow-sm focus:border-[#7c4dff] focus:ring-2 focus:ring-[#7c4dff]/30 outline-none">
    </div>
        <div class="flex gap-4">
            <button type="submit" class="bg-gradient-to-r from-[#7c4dff] to-[#9969ff] text-white border-none rounded-full px-4 py-2 text-sm font-medium cursor-pointer shadow-sm hover:from-[#6a3de8] hover:to-[#7c4dff] hover:-translate-y-0.5 hover:shadow-md transition-all">Filter</button>
            <a href="{{ url_for('admin_transactions') }}" class="bg-gradient-to-r from-red-600 to-red-400 text-white border-none rounded-full px-4 py-2 text-sm font-medium cursor-pointer shadow-sm hover:from-red-700 hover:to-red-500 hover:-translate-y-0.5 hover:shadow-md transition-all">Reset</a>
        </div>
    </form>
    {# === AKHIR FORM FILTER === #}

    <div class="mt-7 rounded-xl shadow-lg overflow-x-auto">
        <table class="min-w-full bg-white">
            <thead>
                <tr class="bg-gradient-to-r from-[#7c4dff] to-[#9969ff] text-white uppercase text-xs font-semibold tracking-wider">
                    <th class="py-4 px-4 text-left">ID</th>
                    <th class="py-4 px-4 text-left">Waktu</th>
                    <th class="py-4 px-4 text-left">Tipe</th>
                    <th class="py-4 px-4 text-left">User Utama</th>
                    <th class="py-4 px-4 text-left">User Terkait</th>
                    <th class="py-4 px-4 text-right">Jumlah</th>
                    <th class="py-4 px-4 text-right">Saldo Sblm</th>
                    <th class="py-4 px-4 text-right">Saldo Stlh</th>
                    <th class="py-4 px-4 text-left">Deskripsi</th>
                </tr>
            </thead>
            <tbody>
                {% for tx in transactions %}
                <tr class="hover:bg-[#f9f7ff] transition-colors">
                    <td class="py-4 px-4 border-b border-[#f0f0ff] text-sm">{{ tx.id }}</td>
                    <td class="py-4 px-4 border-b border-[#f0f0ff] text-sm">{{ tx.timestamp | wib }}</td>
                    <td class="py-4 px-4 border-b border-[#f0f0ff] text-sm">{{ tx.type }}</td>
                    <td class="py-4 px-4 border-b border-[#f0f0ff] text-sm">{{ tx.user.username if tx.user else 'N/A' }} (ID:{{ tx.user_id }})</td>
                    <td class="py-4 px-4 border-b border-[#f0f0ff] text-sm">{{ tx.related_user.username if tx.related_user else 'N/A' }} {% if tx.related_user_id %}(ID:{{ tx.related_user_id }}){% endif %}</td>
                    <td class="py-4 px-4 border-b border-[#f0f0ff] text-sm text-right">{{ tx.amount|rupiah }}</td>
                    <td class="py-4 px-4 border-b border-[#f0f0ff] text-sm text-right">{{ tx.user_balance_before|rupiah }}</td>
                    <td class="py-4 px-4 border-b border-[#f0f0ff] text-sm text-right">{{ tx.user_balance_after|rupiah }}</td>
                    <td class="py-4 px-4 border-b border-[#f0f0ff] text-sm">{{ tx.description if tx.description else '-' }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9" class="text-center py-10 text-gray-400 italic">Tidak ada transaksi ditemukan untuk filter yang dipilih.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Navigasi Pagination -->
    <div class="flex justify-center mt-7">
        <nav aria-label="Page navigation">
            <ul class="flex list-none bg-white rounded-full shadow-sm p-1">
                {% if pagination.has_prev %}
                <li class="page-item">
                    <a class="text-[#7c4dff] px-4 py-2 rounded-full block font-medium min-w-[40px] text-center hover:bg-[#f7f7ff] transition-colors" href="{{ url_for('admin_transactions', page=pagination.prev_num) }}" aria-label="Previous">
                        <span aria-hidden="true">«</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item">
                    <span class="text-gray-400 px-4 py-2 rounded-full block font-medium min-w-[40px] text-center cursor-not-allowed">«</span>
                </li>
                {% endif %}
    
                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}
                {% if page_num == pagination.page %}
                <li class="page-item"><span class="bg-gradient-to-r from-[#7c4dff] to-[#9969ff] text-white px-4 py-2 rounded-full block font-medium min-w-[40px] text-center shadow-md">{{ page_num }}</span></li>
                {% else %}
                <li class="page-item"><a class="text-[#7c4dff] px-4 py-2 rounded-full block font-medium min-w-[40px] text-center hover:bg-[#f7f7ff] transition-colors" href="{{ url_for('admin_transactions', page=page_num) }}">{{ page_num }}</a></li>
                {% endif %}
                {% else %}
                <li class="page-item"><span class="text-gray-400 px-4 py-2 rounded-full block font-medium min-w-[40px] text-center">…</span></li>
                {% endif %}
                {% endfor %}
    
                {% if pagination.has_next %}
                <li class="page-item">
                    <a class="text-[#7c4dff] px-4 py-2 rounded-full block font-medium min-w-[40px] text-center hover:bg-[#f7f7ff] transition-colors" href="{{ url_for('admin_transactions', page=pagination.next_num) }}" aria-label="Next">
                        <span aria-hidden="true">»</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item">
                    <span class="text-gray-400 px-4 py-2 rounded-full block font-medium min-w-[40px] text-center cursor-not-allowed">»</span>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
{% endblock admin_content %}