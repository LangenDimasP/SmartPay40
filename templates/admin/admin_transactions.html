{% extends 'admin_base.html' %}

{% block title %}Admin - Semua Transaksi{% endblock %}

{% block admin_content %}
<style>
    /* G-Plan Style from admin_users.html */
    /* Gaya Umum dan Font */
    body {
        font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #333;
        background-color: #f7f7ff;
        padding: 20px;
    }
    
    h2 {
        color: #7c4dff;
        margin-bottom: 30px;
        font-weight: 600;
        font-size: 28px;
        position: relative;
        padding-bottom: 12px;
        display: inline-block;
        letter-spacing: 0.5px;
    }
    
    /* Gaya Kontainer Utama */
    .admin-container {
        max-width: 100%;
        margin: 0 auto;
        overflow-x: auto;
    }
    
    /* Gaya untuk Form Filter */
    .filter-form {
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: flex-end;
    }
    
    .filter-form select,
    .filter-form input[type="text"],
    .filter-form input[type="date"] {
        border: 1px solid #ddd;
        border-radius: 50px;
        padding: 8px 16px;
        font-size: 0.9rem;
        color: #333;
        background-color: #fff;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.2s;
        outline: none;
    }
    
    .filter-form select:focus,
    .filter-form input[type="text"]:focus,
    .filter-form input[type="date"]:focus {
        border-color: #7c4dff;
        box-shadow: 0 3px 8px rgba(124, 77, 255, 0.3);
    }
    
    .filter-form label {
        font-weight: 500;
        font-size: 0.85rem;
        color: #555;
        margin-bottom: 5px;
        display: block;
    }
    
    .filter-form .btn-filter-submit {
        background: linear-gradient(135deg, #7c4dff, #9969ff);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 8px 16px;
        font-size: 0.85rem;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.2s;
        box-shadow: 0 3px 6px rgba(124, 77, 255, 0.3);
    }
    
    .filter-form .btn-filter-submit:hover {
        background: linear-gradient(135deg, #6a3de8, #7c4dff);
        transform: translateY(-2px);
        box-shadow: 0 5px 10px rgba(124, 77, 255, 0.4);
    }
    
    .filter-form .btn-reset {
        background: linear-gradient(135deg, #f44336, #e57373);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 8px 16px;
        font-size: 0.85rem;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.2s;
        box-shadow: 0 3px 6px rgba(244, 67, 54, 0.3);
    }
    
    .filter-form .btn-reset:hover {
        background: linear-gradient(135deg, #d32f2f, #f44336);
        transform: translateY(-2px);
        box-shadow: 0 5px 10px rgba(244, 67, 54, 0.4);
    }
    
    /* Gaya Tabel */
    .data-table-container {
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(124, 77, 255, 0.15);
        overflow-x: auto;
        margin: 30px 0;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
        background-color: #fff;
    }
    
    .data-table thead tr {
        background: linear-gradient(135deg, #7c4dff 0%, #9969ff 100%);
        color: white;
        text-transform: uppercase;
        font-size: 0.85em;
        letter-spacing: 1px;
    }
    
    .data-table th {
        padding: 16px;
        font-weight: 600;
        text-align: left;
        vertical-align: middle;
        color: white;
    }
    
    .data-table td {
        padding: 16px 15px;
        border-bottom: 1px solid #f0f0ff;
        font-size: 0.95em;
    }
    
    .data-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .data-table tbody tr:hover {
        background-color: #f9f7ff;
        transition: all 0.2s ease;
    }
    
    /* Pagination */
    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 30px;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        list-style: none;
        padding: 0;
        background-color: white;
        border-radius: 50px;
        box-shadow: 0 5px 15px rgba(124, 77, 255, 0.1);
        padding: 5px;
    }
    
    .pagination li {
        margin: 0;
    }
    
    .pagination .page-link {
        color: #7c4dff;
        padding: 10px 16px;
        text-decoration: none;
        border-radius: 50px;
        display: block;
        font-weight: 500;
        min-width: 40px;
        text-align: center;
        transition: all 0.2s;
    }
    
    .pagination .page-item.active .page-link {
        background: linear-gradient(135deg, #7c4dff, #9969ff);
        color: white;
        box-shadow: 0 5px 15px rgba(124, 77, 255, 0.3);
    }
    
    .pagination .page-item.disabled .page-link {
        color: #c4c4c4;
        pointer-events: none;
    }
    
    .pagination .page-link:hover:not(.active) {
        background-color: #f7f7ff;
    }
    
    /* Flash Messages */
    .flash-messages {
        margin-bottom: 25px;
    }
    
    .flash-success {
        background-color: #e8f5e9;
        border-left: 5px solid #00c853;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
    }
    
    .flash-danger {
        background-color: #ffebee;
        border-left: 5px solid #f44336;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
    }
    
    /* Table Empty State */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #9e9e9e;
        font-style: italic;
    }
</style>

<div class="admin-container">
    <h2>Riwayat Semua Transaksi Sistem</h2>

    {# Flash messages #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <p class="flash-{{ category }}">{{ message }}</p>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    {# === FORM FILTER TRANSAKSI ADMIN === #}
    <form method="GET" action="{{ url_for('admin_transactions') }}" class="filter-form">
        <div>
            <label for="start_date">Dari Tgl:</label>
            <input type="date" id="start_date" name="start_date" value="{{ filter_start_date }}">
        </div>
        <div>
            <label for="end_date">Sampai Tgl:</label>
            <input type="date" id="end_date" name="end_date" value="{{ filter_end_date }}">
        </div>
        <div>
            <label for="filter_type">Tipe Transaksi:</label>
            <select id="filter_type" name="filter_type">
                <option value="all" {% if selected_type_filter == 'all' %}selected{% endif %}>Semua Tipe</option>
                <option value="payment" {% if selected_type_filter == 'payment' %}selected{% endif %}>Payment</option>
                <option value="topup" {% if selected_type_filter == 'topup' %}selected{% endif %}>Top Up</option>
                <option value="cashout_vendor" {% if selected_type_filter == 'cashout_vendor' %}selected{% endif %}>Cash Out Vendor</option>
            </select>
        </div>
        <div>
            <label for="username">Username (Utama):</label>
            <input type="text" id="username" name="username" value="{{ filter_username or '' }}" placeholder="Cari Username...">
        </div>
        <div>
            <button type="submit" class="btn btn-filter-submit">Filter</button>
            <a href="{{ url_for('admin_transactions') }}" class="btn btn-reset">Reset</a>
        </div>
    </form>
    {# === AKHIR FORM FILTER === #}

    <div class="data-table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Waktu</th>
                    <th>Tipe</th>
                    <th>User Utama</th>
                    <th>User Terkait</th>
                    <th style="text-align: right;">Jumlah</th>
                    <th style="text-align: right;">Saldo Sblm</th>
                    <th style="text-align: right;">Saldo Stlh</th>
                    <th>Deskripsi</th>
                </tr>
            </thead>
            <tbody>
                {% for tx in transactions %}
                <tr>
                    <td>{{ tx.id }}</td>
                    <td>{{ tx.timestamp | wib }}</td>
                    <td>{{ tx.type }}</td>
                    <td>{{ tx.user.username if tx.user else 'N/A' }} (ID:{{ tx.user_id }})</td>
                    <td>{{ tx.related_user.username if tx.related_user else 'N/A' }} {% if tx.related_user_id %}(ID:{{ tx.related_user_id }}){% endif %}</td>
                    <td style="text-align: right;">{{ tx.amount|rupiah }}</td>
                    <td style="text-align: right;">{{ tx.user_balance_before|rupiah }}</td>
                    <td style="text-align: right;">{{ tx.user_balance_after|rupiah }}</td>
                    <td>{{ tx.description if tx.description else '-' }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9" class="empty-state">Tidak ada transaksi ditemukan untuk filter yang dipilih.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Navigasi Pagination -->
    <div class="pagination-container">
        <nav aria-label="Page navigation">
            <ul class="pagination">
                {% if pagination.has_prev %}
                <li class="page-item">
                    <a class="page-link" injustice href="{{ url_for('admin_transactions', page=pagination.prev_num) }}" aria-label="Previous">
                        <span aria-hidden="true">«</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">«</span>
                </li>
                {% endif %}
    
                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}
                {% if page_num == pagination.page %}
                <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
                {% else %}
                <li class="page-item"><a class="page-link" href="{{ url_for('admin_transactions', page=page_num) }}">{{ page_num }}</a></li>
                {% endif %}
                {% else %}
                <li class="page-item disabled"><span class="page-link">…</span></li>
                {% endif %}
                {% endfor %}
    
                {% if pagination.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('admin_transactions', page=pagination.next_num) }}" aria-label="Next">
                        <span aria-hidden="true">»</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">»</span>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
{% endblock admin_content %}