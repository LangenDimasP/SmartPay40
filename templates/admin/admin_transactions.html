{% extends 'admin_base.html' %}
{% block admin_content %}
<div class="min-h-screen py-8">
  <div class="container mx-auto px-6 max-w-7xl">
    <!-- Header Section -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 mb-8">
      <div class="flex items-center mb-6">
        <div class="w-12 h-12 bg-[#7c4dff] rounded-lg flex items-center justify-center mr-4">
          <svg class="w-6 h-6 text-white" stroke="currentColor" viewBox="0 0 24 24" fill="#ffffff" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M5.07868 5.06891C8.87402 1.27893 15.0437 1.31923 18.8622 5.13778C22.6824 8.95797 22.7211 15.1313 18.9262 18.9262C15.1312 22.7211 8.95793 22.6824 5.13774 18.8622C2.87389 16.5984 1.93904 13.5099 2.34047 10.5812C2.39672 10.1708 2.775 9.88377 3.18537 9.94002C3.59575 9.99627 3.88282 10.3745 3.82658 10.7849C3.4866 13.2652 4.27782 15.881 6.1984 17.8016C9.44288 21.0461 14.6664 21.0646 17.8655 17.8655C21.0646 14.6664 21.046 9.44292 17.8015 6.19844C14.5587 2.95561 9.33889 2.93539 6.13935 6.12957L6.88705 6.13333C7.30126 6.13541 7.63535 6.47288 7.63327 6.88709C7.63119 7.3013 7.29372 7.63539 6.87951 7.63331L4.33396 7.62052C3.92269 7.61845 3.58981 7.28556 3.58774 6.8743L3.57495 4.32874C3.57286 3.91454 3.90696 3.57707 4.32117 3.57498C4.73538 3.5729 5.07285 3.907 5.07493 4.32121L5.07868 5.06891ZM11.9999 7.24992C12.4141 7.24992 12.7499 7.58571 12.7499 7.99992V11.6893L15.0302 13.9696C15.3231 14.2625 15.3231 14.7374 15.0302 15.0302C14.7373 15.3231 14.2624 15.3231 13.9696 15.0302L11.2499 12.3106V7.99992C11.2499 7.58571 11.5857 7.24992 11.9999 7.24992Z"/>
</svg>
        </div>
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Riwayat Transaksi</h1>
          <p class="text-gray-600 mt-1">Kelola dan lacak semua transaksi sistem secara real-time</p>
        </div>
      </div>

      <!-- Flash Messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="mb-4 space-y-2">
            {% for category, message in messages %}
              <div class="p-4 rounded-lg border-l-4 {% if category == 'success' %}bg-green-50 border-green-600 text-green-800{% else %}bg-red-50 border-red-600 text-red-800{% endif %}">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <!-- Filter Form -->
      <form method="GET" action="{{ url_for('admin_transactions') }}" class="grid md:grid-cols-5 gap-4 items-end">
        <div>
          <label for="start_date" class="block text-sm font-medium text-gray-700 mb-1">Dari Tanggal</label>
          <input type="date" id="start_date" name="start_date" value="{{ filter_start_date }}" 
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#7c4dff] focus:border-[#7c4dff] bg-white" />
        </div>
        <div>
          <label for="end_date" class="block text-sm font-medium text-gray-700 mb-1">Sampai Tanggal</label>
          <input type="date" id="end_date" name="end_date" value="{{ filter_end_date }}" 
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#7c4dff] focus:border-[#7c4dff] bg-white" />
        </div>
        <div>
          <label for="filter_type" class="block text-sm font-medium text-gray-700 mb-1">Tipe Transaksi</label>
          <select id="filter_type" name="filter_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#7c4dff] focus:border-[#7c4dff] bg-white">
            <option value="all" {% if selected_type_filter == 'all' %}selected{% endif %}>Semua Tipe</option>
            <option value="payment" {% if selected_type_filter == 'payment' %}selected{% endif %}>Payment</option>
            <option value="topup" {% if selected_type_filter == 'topup' %}selected{% endif %}>Top Up</option>
            <option value="cashout_vendor" {% if selected_type_filter == 'cashout_vendor' %}selected{% endif %}>Cash Out Vendor</option>
            <option value="transfer" {% if selected_type_filter == 'transfer' %}selected{% endif %}>Transfer</option>
          </select>
        </div>
        <div>
          <label for="transaction_id" class="block text-sm font-medium text-gray-700 mb-1">ID Transaksi</label>
          <input type="number" id="transaction_id" name="transaction_id" value="{{ filter_transaction_id or '' }}"
                 placeholder="Cari ID..."
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#7c4dff] focus:border-[#7c4dff] bg-white" />
        </div>
        <div class="flex gap-2">
          <button type="submit" class="flex-1 px-4 py-2.5 bg-gradient-to-r from-[#7c4dff] to-[#9969ff] text-white font-medium rounded-lg shadow-sm hover:from-[#6a3de8] hover:to-[#7c4dff] transition-all">
            Filter
          </button>
          <a href="{{ url_for('admin_transactions') }}" class="px-4 py-2.5 bg-red-500 hover:bg-red-600 text-white font-medium rounded-lg transition-colors">
            Reset
          </a>
        </div>
      </form>
    </div>

    <!-- Transactions Table Section -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
      <div class="p-6 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-900 flex items-center">
          <svg class="w-8 h-8 mr-2 text-[#7c4dff]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Semua Transaksi Sistem
        </h2>
      </div>

      <!-- Table -->
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
              <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu</th>
              <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipe</th>
              <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User Utama</th>
              <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User Terkait</th>
              <th class="px-6 py-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
              <th class="px-6 py-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo Sblm</th>
              <th class="px-6 py-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo Stlh</th>
              <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {% for tx in transactions %}
            <tr class="hover:bg-gray-50 transition-colors">
              <td class="px-6 py-4 text-sm text-gray-900 font-mono">{{ tx.id }}</td>
              <td class="px-6 py-4 text-sm text-gray-600">{{ tx.timestamp | wib }}</td>
              <td class="px-6 py-4 text-sm">
                <span class="px-2.5 py-0.5 rounded-full text-xs font-medium
                  {% if tx.type == 'payment' %}bg-blue-100 text-blue-800
                  {% elif tx.type == 'topup' %}bg-green-100 text-green-800
                  {% elif tx.type == 'cashout_vendor' %}bg-orange-100 text-orange-800
                  {% elif tx.type == 'transfer' %}bg-purple-100 text-purple-800
                  {% else %}bg-gray-100 text-gray-800{% endif %}">
                  {{ tx.type|title }}
                </span>
              </td>
              <td class="px-6 py-4 text-sm text-gray-900">
                <div>{{ tx.user.username if tx.user else 'N/A' }}</div>
                <div class="text-xs text-gray-500">ID:{{ tx.user_id }}</div>
              </td>
              <td class="px-6 py-4 text-sm text-gray-600">
                {% if tx.related_user %}
                  <div>{{ tx.related_user.username }}</div>
                  <div class="text-xs text-gray-500">ID:{{ tx.related_user_id }}</div>
                {% else %}
                  <span class="text-gray-400">-</span>
                {% endif %}
              </td>
              <td class="px-6 py-4 text-sm text-right font-medium text-gray-900">{{ tx.amount|rupiah }}</td>
              <td class="px-6 py-4 text-sm text-right text-gray-600">{{ tx.user_balance_before|rupiah }}</td>
              <td class="px-6 py-4 text-sm text-right text-gray-900 font-medium">{{ tx.user_balance_after|rupiah }}</td>
              <td class="px-6 py-4 text-sm text-gray-700">{{ tx.description if tx.description else '-' }}</td>
            </tr>
            {% else %}
            <tr>
              <td colspan="9" class="px-6 py-12 text-center text-gray-500">
                <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-5 0a3 3 0 100 6H9a3 3 0 000-6zm7 0a3 3 0 100 6h-1a3 3 0 000-6h1z" />
                </svg>
                <p class="text-lg font-medium mb-1">Tidak ada transaksi ditemukan</p>
                <p class="text-sm">Coba sesuaikan filter tanggal atau tipe transaksi</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    <!-- Pagination -->
    {% if transactions %}
    <div class="px-6 py-4 border-t border-gray-200 bg-gray-50">
      <div class="flex items-center justify-between">
        <div class="text-sm text-gray-600">
          Menampilkan halaman <span class="font-medium">{{ pagination.page }}</span> dari <span class="font-medium">{{ pagination.pages }}</span>
        </div>
        <div class="flex items-center gap-2">
          <!-- Previous Button -->
          {% set filter_args = {} %}
          {% for key, value in request.args.items() %}
            {% if key != 'page' %}
              {% set _ = filter_args.update({key: value}) %}
            {% endif %}
          {% endfor %}
          <button class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-50 transition-colors {{ 'opacity-50 cursor-not-allowed' if not pagination.has_prev else '' }}"
                  {{ 'disabled' if not pagination.has_prev }}
                  onclick="window.location.href='{{ url_for('admin_transactions', page=pagination.prev_num, **filter_args) }}'">
            Previous
          </button>
          <div class="flex gap-1">
            {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
              {% if page_num %}
                {% if page_num == pagination.page %}
                  <span class="px-3 py-1.5 bg-[#7c4dff] text-white text-sm rounded-lg font-medium shadow-sm">{{ page_num }}</span>
                {% else %}
                  <!-- Page Number Link -->
                  <a href="{{ url_for('admin_transactions', page=page_num, **filter_args) }}" class="px-3 py-1.5 bg-white border border-gray-300 text-gray-700 text-sm rounded-lg hover:bg-gray-50 transition-colors">{{ page_num }}</a>
                {% endif %}
              {% else %}
                <span class="px-3 py-1.5 text-gray-400 text-sm">…</span>
              {% endif %}
            {% endfor %}
          </div>
          <!-- Next Button -->
          <button class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-50 transition-colors {{ 'opacity-50 cursor-not-allowed' if not pagination.has_next else '' }}"
                  {{ 'disabled' if not pagination.has_next }}
                  onclick="window.location.href='{{ url_for('admin_transactions', page=pagination.next_num, **filter_args) }}'">
            Next
          </button>
        </div>
      </div>
    </div>
    {% endif %}
    </div>
  </div>
</div>
{% endblock %}